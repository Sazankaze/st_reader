(function(){"use strict";var e={2733:function(e,t,a){var s=a(3751),i=(a(8111),a(2489),a(8237),a(641)),o=a(33);const n={key:0,class:"upload-area"},r={class:"upload-container"},l={key:0,class:"upload-card single-upload"},c={for:"file-input",class:"upload-label"},d={key:1,class:"upload-card zip-upload"},h={for:"zip-input",class:"upload-label"},g={key:2,class:"loading-status"},u={key:1,class:"dashboard-container"},p={class:"dashboard-header"},m={class:"header-column"},v={class:"header-title-row"},k={class:"dashboard-meta"},b={class:"dashboard-content"},y={class:"stats-overview"},f={class:"stat-hero"},x={class:"hero-value"},S={class:"stat-sub-row"},C={class:"sub-stat"},L={class:"sub-value"},F={class:"sub-stat"},w={class:"sub-value"},M={class:"sub-stat"},T={class:"sub-value"},D={key:0,class:"dashboard-calendar-section"},E={class:"dash-cal-header"},I={class:"dash-cal-title"},_={class:"dash-cal-meta"},P={key:0,class:"calendar-widget dashboard-widget"},N={class:"calendar-nav"},R=["disabled"],$={class:"current-month-label"},O=["disabled"],X={class:"month-card single-view"},U={class:"month-grid"},H=["onMouseenter"],A={class:"day-number"},z={class:"month-footer-stats"},J={class:"footer-stat"},j={class:"f-value"},W={class:"footer-stat"},Y={class:"f-value"},B={key:1,class:"heatmap-widget"},Q={class:"calendar-nav"},G=["disabled"],V={class:"current-month-label"},K=["disabled"],q={class:"heatmap-scroll-container"},Z={class:"heatmap-grid"},ee=["onMouseenter"],te={key:1,style:{padding:"20px",color:"#999","font-size":"0.9rem"}},ae={class:"heatmap-footer"},se={class:"heatmap-hint"},ie={class:"filter-bar"},oe={class:"character-groups"},ne={class:"char-header"},re={class:"char-header-left"},le={class:"char-name"},ce={class:"char-stats"},de=["onClick"],he={class:"file-grid"},ge=["onClick"],ue={class:"file-info"},pe=["title"],me={class:"file-meta"},ve={class:"meta-tag cn"},ke={class:"meta-tag turns"},be={class:"file-date"},ye={key:2,class:"chat-container"},fe={class:"chat-header"},xe={class:"header-content"},Se={class:"chat-title"},Ce={class:"chat-meta"},Le={key:0},Fe={class:"message-count"},we={class:"header-actions"},Me={key:0},Te={key:0},De={key:0},Ee={class:"icon-label-row"},Ie={key:0,class:"search-bar"},_e={class:"search-input-wrapper"},Pe={class:"search-info"},Ne={key:0},Re={key:1,class:"regex-manager tag-filter-manager"},$e={class:"regex-header"},Oe={class:"regex-actions"},Xe={key:0,class:"script-form"},Ue={class:"form-group"},He={class:"form-group"},Ae={class:"form-group"},ze={class:"form-group checkbox-group"},Je={class:"form-buttons"},je={class:"script-list"},We={key:0,class:"no-scripts"},Ye={class:"script-info"},Be={class:"script-name"},Qe={class:"script-regex"},Ge={class:"script-controls"},Ve=["onClick","disabled"],Ke=["onClick","disabled"],qe=["onClick"],Ze=["onClick"],et=["onClick"],tt={key:2,class:"regex-manager"},at={class:"regex-header"},st={class:"regex-actions"},it=["disabled"],ot={key:0,class:"script-form"},nt={class:"form-group"},rt={class:"form-group"},lt={class:"form-group"},ct={class:"form-group checkbox-group"},dt={class:"form-buttons"},ht={class:"script-list"},gt={key:0,class:"no-scripts"},ut=["onDragstart","onDrop"],pt={class:"script-info"},mt={class:"script-name"},vt={class:"script-regex"},kt={class:"script-controls"},bt=["onClick","disabled"],yt=["onClick","disabled"],ft=["onClick"],xt=["onClick"],St=["onClick"],Ct={key:3,class:"regex-manager favorites-panel"},Lt={class:"fav-header-minimal"},Ft={class:"fav-toolbar"},wt={class:"fav-tabs-simple"},Mt={class:"fav-actions-simple"},Tt=["disabled"],Dt=["disabled"],Et={key:0,class:"script-list favorites-list"},It={key:0,class:"no-scripts"},_t=["onClick"],Pt={class:"favorite-content"},Nt={class:"favorite-type"},Rt={style:{color:"#999","font-size":"0.9em"}},$t={class:"favorite-text"},Ot={class:"favorite-meta"},Xt={key:0,style:{"font-weight":"bold",color:"#555"}},Ut={class:"favorite-actions"},Ht=["onClick"],At=["onClick"],zt={key:1,class:"script-list favorites-list"},Jt={key:0,class:"no-scripts"},jt={style:{background:"#f9f9f9",padding:"6px 10px","font-weight":"bold","font-size":"0.85rem","border-bottom":"1px solid #eee",color:"#444",display:"flex","align-items":"center",gap:"5px"}},Wt={class:"favorite-content"},Yt={class:"favorite-type"},Bt={style:{color:"#999","margin-left":"5px"}},Qt={key:2,style:{color:"#e91e63","font-size":"0.7rem","margin-left":"8px",border:"1px solid #e91e63",padding:"0 3px","border-radius":"3px",opacity:"0.8"}},Gt={class:"favorite-text",style:{color:"#666"}},Vt={class:"favorite-actions"},Kt=["onClick"],qt=["onClick"],Zt={key:4,class:"regex-manager style-panel"},ea={class:"regex-header"},ta={class:"regex-actions"},aa={class:"style-settings"},sa={class:"style-group font-group"},ia={class:"style-flex-row"},oa={key:0,label:"自定义字体"},na=["value"],ra={class:"sliders-grid"},la={class:"style-group compact-group"},ca={class:"style-label"},da={class:"style-group compact-group"},ha={class:"style-label"},ga={class:"style-group compact-group"},ua={class:"style-label"},pa={class:"style-group compact-group"},ma={class:"style-label"},va={class:"color-grid"},ka={class:"style-group compact-group"},ba={class:"color-picker-row"},ya={class:"color-value"},fa={class:"style-group compact-group"},xa={class:"color-picker-row"},Sa={class:"color-value"},Ca={class:"style-group compact-group"},La={class:"color-picker-row"},Fa={class:"color-value"},wa={class:"style-group compact-group"},Ma={class:"color-picker-row"},Ta={class:"color-value"},Da={class:"style-group"},Ea={class:"align-options"},Ia={class:"style-preview"},_a={key:0,class:"custom-fonts-section"},Pa={class:"custom-font-list"},Na={class:"custom-font-name"},Ra=["onClick"],$a={class:"modal-dialog custom-font-dialog"},Oa={class:"modal-header"},Xa={class:"modal-body"},Ua={class:"form-group"},Ha={class:"import-tabs"},Aa={class:"import-method"},za=["disabled"],Ja={class:"import-method"},ja=["disabled"],Wa={key:0,class:"file-selected"},Ya={class:"modal-footer"},Ba={class:"message-header"},Qa={class:"speaker-name"},Ga={class:"message-info"},Va={key:0,class:"timestamp"},Ka={key:1,class:"model-tag"},qa=["onClick","title"],Za=["onClick","title"],es={key:0,class:"message-edit-form"},ts={class:"edit-actions"},as=["onMouseup"],ss=["innerHTML"],is={key:1,class:"message-content-html"},os={class:"html-preview-header"},ns=["onClick"],rs=["srcdoc"],ls={key:1,class:"html-code"},cs=["innerHTML","onMouseup"],ds={key:2,class:"swipe-controls"},hs=["onClick","disabled"],gs={class:"swipe-indicator"},us=["onClick","disabled"],ps=["innerHTML"],ms={class:"reading-progress"},vs={class:"reading-floor"},ks={class:"reading-controls"},bs=["disabled"],ys=["disabled"],fs={key:9,class:"pagination-bar pagination-bottom"},xs={class:"pagination-info"},Ss={key:0,class:"filter-hint"},Cs={class:"pagination-controls"},Ls=["disabled"],Fs=["disabled"],ws={class:"page-indicator"},Ms=["disabled"],Ts=["disabled"],Ds={class:"export-dialog"},Es={class:"export-dialog-header"},Is={class:"export-dialog-body"},_s={class:"export-range"},Ps={class:"range-inputs"},Ns={class:"range-input-group"},Rs=["max"],$s={class:"range-input-group"},Os=["max"],Xs={class:"range-hint"},Us={class:"export-options"},Hs={class:"export-option"},As={class:"export-option"},zs={class:"export-preview"},Js={class:"export-preview-content"},js={class:"export-dialog-footer"},Ws={class:"modal-dialog intimacy-dialog"},Ys={class:"modal-header"},Bs={class:"modal-body"},Qs={class:"stats-grid"},Gs={class:"stat-card"},Vs={class:"stat-value text-sm"},Ks={class:"stat-sub"},qs={class:"stat-card"},Zs={class:"stat-value"},ei={class:"stat-card"},ti={class:"stat-value"},ai={class:"stat-sub"},si={class:"stat-card"},ii={class:"stat-value"},oi={class:"calendar-section"},ni={key:0,class:"calendar-widget"},ri={class:"calendar-nav"},li=["disabled"],ci={class:"current-month-label"},di=["disabled"],hi={class:"month-card single-view"},gi={class:"month-grid"},ui=["onMouseenter"],pi={class:"day-number"},mi={class:"month-footer-stats"},vi={class:"footer-stat"},ki={class:"f-value"},bi={class:"footer-stat"},yi={class:"f-value"},fi={key:1,class:"no-calendar-data"},xi={class:"tooltip-header"},Si={class:"tooltip-row"},Ci={class:"tooltip-row"};function Li(e,t,a,Li,Fi,wi){const Mi=(0,i.g2)("Icon");return(0,i.uX)(),(0,i.CE)("div",{class:(0,o.C4)(["st-reader",{"dark-mode":Fi.isDarkMode}])},["home"===Fi.viewMode?((0,i.uX)(),(0,i.CE)("div",n,[(0,i.Lk)("div",r,[Fi.loadingStatus?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",l,[(0,i.Lk)("input",{type:"file",ref:"fileInput",onChange:t[0]||(t[0]=(...e)=>wi.handleFileUpload&&wi.handleFileUpload(...e)),accept:".jsonl",id:"file-input",class:"file-input"},null,544),(0,i.Lk)("label",c,[(0,i.bF)(Mi,{icon:"bi:file-earmark-text",class:"upload-icon"}),t[119]||(t[119]=(0,i.Lk)("div",{class:"upload-text"},"单文件阅读",-1)),t[120]||(t[120]=(0,i.Lk)("div",{class:"upload-hint"},"选择单个 .jsonl 文件",-1))])])),Fi.loadingStatus?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",d,[(0,i.Lk)("input",{type:"file",ref:"zipInput",onChange:t[1]||(t[1]=(...e)=>wi.handleZipUpload&&wi.handleZipUpload(...e)),accept:".zip",id:"zip-input",class:"file-input"},null,544),(0,i.Lk)("label",h,[(0,i.bF)(Mi,{icon:"bi:file-earmark-zip",class:"upload-icon"}),t[121]||(t[121]=(0,i.Lk)("div",{class:"upload-text"},"数据仪表盘",-1)),t[122]||(t[122]=(0,i.Lk)("div",{class:"upload-hint"},"上传 ZIP 压缩包 · 角色分类 · 统计分析",-1))])])),Fi.loadingStatus?((0,i.uX)(),(0,i.CE)("div",g,[t[123]||(t[123]=(0,i.Lk)("div",{class:"spinner"},null,-1)),(0,i.eW)(" "+(0,o.v_)(Fi.loadingStatus),1)])):(0,i.Q3)("",!0)])])):"dashboard"===Fi.viewMode?((0,i.uX)(),(0,i.CE)("div",u,[(0,i.Lk)("div",p,[(0,i.Lk)("div",m,[(0,i.Lk)("button",{onClick:t[2]||(t[2]=(...e)=>wi.resetReader&&wi.resetReader(...e)),class:"back-btn"},[(0,i.bF)(Mi,{icon:"akar-icons:arrow-left"}),t[124]||(t[124]=(0,i.eW)(" 返回首页 ",-1))]),(0,i.Lk)("div",v,[t[125]||(t[125]=(0,i.Lk)("h1",null,"数据档案",-1)),(0,i.Lk)("div",k," 共 "+(0,o.v_)(Fi.dashboardData.totalFiles)+" 个文件 ",1)])])]),(0,i.Lk)("div",b,[(0,i.Lk)("div",y,[(0,i.Lk)("div",f,[(0,i.Lk)("div",x,(0,o.v_)(Fi.dashboardData.totalEffectiveCN.toLocaleString()),1),t[126]||(t[126]=(0,i.Lk)("div",{class:"hero-label"},"有效汉字总数 (仅供参考)",-1))]),t[130]||(t[130]=(0,i.Lk)("div",{class:"stat-divider"},null,-1)),(0,i.Lk)("div",S,[(0,i.Lk)("div",C,[(0,i.Lk)("div",L,(0,o.v_)(Object.keys(Fi.dashboardData.groups).length),1),t[127]||(t[127]=(0,i.Lk)("div",{class:"sub-label"},"角色数量",-1))]),(0,i.Lk)("div",F,[(0,i.Lk)("div",w,(0,o.v_)(Fi.dashboardData.totalTurns.toLocaleString()),1),t[128]||(t[128]=(0,i.Lk)("div",{class:"sub-label"},"总对话楼层",-1))]),(0,i.Lk)("div",M,[(0,i.Lk)("div",T,(0,o.v_)(Fi.dashboardData.totalRerolls.toLocaleString()),1),t[129]||(t[129]=(0,i.Lk)("div",{class:"sub-label"},"重Roll次数",-1))])])]),Fi.dashboardCalendar.months.length>0?((0,i.uX)(),(0,i.CE)("div",D,[(0,i.Lk)("div",E,[(0,i.Lk)("div",I,[(0,i.bF)(Mi,{icon:"bi:calendar-check"}),t[131]||(t[131]=(0,i.eW)(" 酒馆日记 ",-1))]),(0,i.Lk)("div",_," 活跃 "+(0,o.v_)(Fi.dashboardCalendar.activeDays)+" 天 · 累计 "+(0,o.v_)(Fi.dashboardCalendar.totalMessages)+" 条消息 ",1),(0,i.Lk)("button",{class:"view-toggle-btn",onClick:t[3]||(t[3]=e=>Fi.calendarViewMode="month"===Fi.calendarViewMode?"year":"month")},[(0,i.bF)(Mi,{icon:"month"===Fi.calendarViewMode?"bi:grid-3x3":"bi:calendar-date"},null,8,["icon"]),(0,i.eW)(" "+(0,o.v_)("month"===Fi.calendarViewMode?"切换年视图":"切换月视图"),1)])]),"month"===Fi.calendarViewMode?((0,i.uX)(),(0,i.CE)("div",P,[(0,i.Lk)("div",N,[(0,i.Lk)("button",{onClick:t[4]||(t[4]=(...e)=>wi.prevDashMonth&&wi.prevDashMonth(...e)),disabled:Fi.dashboardCalendar.currentMonthIdx>=Fi.dashboardCalendar.months.length-1,class:"nav-btn"},"◀",8,R),(0,i.Lk)("div",$,(0,o.v_)(Fi.dashboardCalendar.months[Fi.dashboardCalendar.currentMonthIdx].year)+"年 "+(0,o.v_)(Fi.dashboardCalendar.months[Fi.dashboardCalendar.currentMonthIdx].month)+"月 ",1),(0,i.Lk)("button",{onClick:t[5]||(t[5]=(...e)=>wi.nextDashMonth&&wi.nextDashMonth(...e)),disabled:Fi.dashboardCalendar.currentMonthIdx<=0,class:"nav-btn"},"▶",8,O)]),(0,i.Lk)("div",X,[(0,i.Lk)("div",U,[t[132]||(t[132]=(0,i.Fv)('<div class="weekday-header" data-v-75685e9c>日</div><div class="weekday-header" data-v-75685e9c>一</div><div class="weekday-header" data-v-75685e9c>二</div><div class="weekday-header" data-v-75685e9c>三</div><div class="weekday-header" data-v-75685e9c>四</div><div class="weekday-header" data-v-75685e9c>五</div><div class="weekday-header" data-v-75685e9c>六</div>',7)),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.dashboardCalendar.months[Fi.dashboardCalendar.currentMonthIdx].paddingStart,e=>((0,i.uX)(),(0,i.CE)("div",{key:"pad-"+e,class:"day-cell padding"}))),128)),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.dashboardCalendar.months[Fi.dashboardCalendar.currentMonthIdx].days,e=>((0,i.uX)(),(0,i.CE)("div",{key:e.dateStr,class:(0,o.C4)(["day-cell",{"has-data":e.count>0}]),style:(0,o.Tr)({backgroundColor:e.bgStyle}),onMouseenter:t=>wi.showDayTooltip(t,e),onMouseleave:t[6]||(t[6]=(...e)=>wi.hideDayTooltip&&wi.hideDayTooltip(...e)),onMousemove:t[7]||(t[7]=e=>wi.moveDayTooltip(e))},[(0,i.Lk)("span",A,(0,o.v_)(e.dayNum),1)],46,H))),128))])]),(0,i.Lk)("div",z,[(0,i.Lk)("div",J,[t[133]||(t[133]=(0,i.Lk)("span",{class:"f-label"},"本月消息",-1)),(0,i.Lk)("span",j,(0,o.v_)(Fi.dashboardCalendar.months[Fi.dashboardCalendar.currentMonthIdx].totalCount.toLocaleString()),1)]),t[135]||(t[135]=(0,i.Lk)("div",{class:"footer-divider"},null,-1)),(0,i.Lk)("div",W,[t[134]||(t[134]=(0,i.Lk)("span",{class:"f-label"},"本月字数",-1)),(0,i.Lk)("span",Y,(0,o.v_)(Fi.dashboardCalendar.months[Fi.dashboardCalendar.currentMonthIdx].totalChars.toLocaleString()),1)])])])):((0,i.uX)(),(0,i.CE)("div",B,[(0,i.Lk)("div",Q,[(0,i.Lk)("button",{onClick:t[8]||(t[8]=(...e)=>wi.prevHeatmapYear&&wi.prevHeatmapYear(...e)),disabled:Fi.currentHeatmapYear<=Fi.heatmapYears[0],class:"nav-btn"},"◀",8,G),(0,i.Lk)("div",V,(0,o.v_)(Fi.currentHeatmapYear)+" 年度总览 ",1),(0,i.Lk)("button",{onClick:t[9]||(t[9]=(...e)=>wi.nextHeatmapYear&&wi.nextHeatmapYear(...e)),disabled:Fi.currentHeatmapYear>=Fi.heatmapYears[Fi.heatmapYears.length-1],class:"nav-btn"},"▶",8,K)]),(0,i.Lk)("div",q,[(0,i.Lk)("div",Z,[t[136]||(t[136]=(0,i.Lk)("div",{class:"heatmap-week-labels"},[(0,i.Lk)("span",null,"日"),(0,i.Lk)("span",null," "),(0,i.Lk)("span",null,"二"),(0,i.Lk)("span",null," "),(0,i.Lk)("span",null,"四"),(0,i.Lk)("span",null," "),(0,i.Lk)("span",null,"六")],-1)),Fi.currentHeatmapYear&&Fi.heatmapData[Fi.currentHeatmapYear]?((0,i.uX)(!0),(0,i.CE)(i.FK,{key:0},(0,i.pI)(Fi.heatmapData[Fi.currentHeatmapYear],(e,a)=>((0,i.uX)(),(0,i.CE)("div",{key:a,class:"heatmap-col"},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e,(e,a)=>((0,i.uX)(),(0,i.CE)("div",{key:a,class:(0,o.C4)(["heatmap-cell",{empty:!e||!e.hasData}]),style:(0,o.Tr)({backgroundColor:e&&e.hasData?e.bgStyle:""}),onMouseenter:t=>e&&wi.showDayTooltip(t,e),onMouseleave:t[10]||(t[10]=(...e)=>wi.hideDayTooltip&&wi.hideDayTooltip(...e)),onMousemove:t[11]||(t[11]=e=>wi.moveDayTooltip(e))},null,46,ee))),128))]))),128)):((0,i.uX)(),(0,i.CE)("div",te," 暂无数据 "))])]),(0,i.Lk)("div",ae,[t[137]||(t[137]=(0,i.Lk)("div",{class:"heatmap-legend"},[(0,i.Lk)("span",null,"少"),(0,i.Lk)("span",{class:"legend-item level-1",style:{background:"rgb(248, 187, 208)"}}),(0,i.Lk)("span",{class:"legend-item level-2",style:{background:"rgb(233, 30, 99)"}}),(0,i.Lk)("span",{class:"legend-item level-3",style:{background:"rgb(136, 14, 79)"}}),(0,i.Lk)("span",null,"多")],-1)),(0,i.Lk)("div",se," * 包含 "+(0,o.v_)(Fi.heatmapData[Fi.currentHeatmapYear]?.length||0)+" 周 ",1)])]))])):(0,i.Q3)("",!0),(0,i.Lk)("div",ie,[(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[12]||(t[12]=e=>Fi.dashboardSearch=e),type:"text",placeholder:"搜索角色名或文件名...",class:"dash-search-input",style:{"padding-left":"2.5rem"}},null,512),[[s.Jo,Fi.dashboardSearch]])]),(0,i.Lk)("div",oe,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(wi.filteredDashboardGroups,(e,t)=>((0,i.uX)(),(0,i.CE)("div",{key:t,class:"char-group"},[(0,i.Lk)("div",ne,[(0,i.Lk)("div",re,[(0,i.Lk)("div",le,[(0,i.bF)(Mi,{icon:"bxs:user",class:"char-icon"}),(0,i.eW)(" "+(0,o.v_)(t),1)]),(0,i.Lk)("div",ce,(0,o.v_)(e.length)+" 个会话 · "+(0,o.v_)(e.reduce((e,t)=>e+t.effectiveCN,0).toLocaleString())+" 字 ",1)]),(0,i.Lk)("button",{onClick:(0,s.D$)(a=>wi.openDashboardIntimacy(t,e),["stop"]),class:"action-button intimacy-btn icon-only-btn",title:"查看亲密度"},[(0,i.bF)(Mi,{icon:"bxs:heart",class:"heart-icon"})],8,de)]),(0,i.Lk)("div",he,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e,e=>((0,i.uX)(),(0,i.CE)("div",{key:e.fileName,class:"file-card",onClick:t=>wi.openChatFromDashboard(e)},[(0,i.Lk)("div",ue,[(0,i.Lk)("div",{class:"file-name",title:e.fileName},(0,o.v_)(e.fileName),9,pe),(0,i.Lk)("div",me,[(0,i.Lk)("span",ve,(0,o.v_)(e.effectiveCN.toLocaleString())+" 字",1),(0,i.Lk)("span",ke,(0,o.v_)(e.totalTurns)+" 楼",1)])]),(0,i.Lk)("div",be,(0,o.v_)(e.lastDate),1)],8,ge))),128))])]))),128))])])])):((0,i.uX)(),(0,i.CE)("div",ye,[(0,i.Lk)("div",fe,[(0,i.Lk)("div",xe,[Fi.fromDashboard?((0,i.uX)(),(0,i.CE)("button",{key:0,onClick:t[13]||(t[13]=(...e)=>wi.backToDashboard&&wi.backToDashboard(...e)),class:"back-link-btn"},[(0,i.bF)(Mi,{icon:"akar-icons:arrow-left"}),t[138]||(t[138]=(0,i.eW)(" 返回列表 ",-1))])):(0,i.Q3)("",!0),(0,i.Lk)("h1",Se,(0,o.v_)(Fi.metadata.character_name||"聊天记录"),1),(0,i.Lk)("div",Ce,[Fi.metadata.create_date?((0,i.uX)(),(0,i.CE)("span",Le,(0,o.v_)(Fi.metadata.create_date),1)):(0,i.Q3)("",!0),(0,i.Lk)("span",Fe,(0,o.v_)(Fi.messages.length)+" 条消息",1)])]),(0,i.Lk)("div",we,[(0,i.Lk)("button",{onClick:t[14]||(t[14]=(...e)=>wi.toggleSearchBar&&wi.toggleSearchBar(...e)),class:(0,o.C4)(["action-button","search-toggle",{active:Fi.showSearchBar}])}," 搜索 ",2),(0,i.Lk)("button",{onClick:t[15]||(t[15]=(...e)=>wi.toggleTagFilterManager&&wi.toggleTagFilterManager(...e)),class:(0,o.C4)(["action-button",{active:Fi.showTagFilterManager}])},[t[139]||(t[139]=(0,i.eW)(" 标签过滤 ",-1)),Fi.tagFilters.length?((0,i.uX)(),(0,i.CE)("span",Me,"("+(0,o.v_)(Fi.tagFilters.filter(e=>!e.disabled).length)+")",1)):(0,i.Q3)("",!0)],2),(0,i.Lk)("button",{onClick:t[16]||(t[16]=(...e)=>wi.toggleRegexManager&&wi.toggleRegexManager(...e)),class:(0,o.C4)(["action-button","regex-button",{active:Fi.showRegexManager}])},[t[140]||(t[140]=(0,i.eW)(" 正则脚本 ",-1)),Fi.regexScripts.length?((0,i.uX)(),(0,i.CE)("span",Te,"("+(0,o.v_)(Fi.regexScripts.filter(e=>!e.disabled).length)+")",1)):(0,i.Q3)("",!0)],2),(0,i.Lk)("button",{onClick:t[17]||(t[17]=(...e)=>wi.toggleFavoritesPanel&&wi.toggleFavoritesPanel(...e)),class:(0,o.C4)(["action-button",{active:Fi.showFavoritesPanel}])},[t[141]||(t[141]=(0,i.eW)(" 收藏夹 ",-1)),Fi.favorites.length?((0,i.uX)(),(0,i.CE)("span",De,"("+(0,o.v_)(Fi.favorites.length)+")",1)):(0,i.Q3)("",!0)],2),(0,i.Lk)("button",{onClick:t[18]||(t[18]=(...e)=>wi.openIntimacyModal&&wi.openIntimacyModal(...e)),class:"action-button intimacy-btn"},[(0,i.bF)(Mi,{icon:"bxs:heart",class:"heart-icon"}),t[142]||(t[142]=(0,i.eW)(" 亲密度 ",-1))]),(0,i.Lk)("button",{onClick:t[19]||(t[19]=(...e)=>wi.toggleReadingMode&&wi.toggleReadingMode(...e)),class:(0,o.C4)(["action-button","reading-mode-btn",{active:Fi.readingMode}])}," 阅读模式 ",2),(0,i.Lk)("button",{onClick:t[20]||(t[20]=(...e)=>wi.openExportRangeDialog&&wi.openExportRangeDialog(...e)),class:"action-button"}," 导出 "),(0,i.Lk)("button",{onClick:t[21]||(t[21]=(...e)=>wi.toggleStylePanel&&wi.toggleStylePanel(...e)),class:(0,o.C4)(["action-button",{active:Fi.showStylePanel}])}," 样式 ",2),(0,i.Lk)("button",{onClick:t[22]||(t[22]=(...e)=>wi.toggleDarkMode&&wi.toggleDarkMode(...e)),class:"action-button mode-toggle"},[(0,i.Lk)("div",Ee,[Fi.isDarkMode?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[(0,i.bF)(Mi,{icon:"heroicons-solid:sun",class:"mode-icon sun"}),t[143]||(t[143]=(0,i.Lk)("span",null,"日间",-1))],64)):((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[(0,i.bF)(Mi,{icon:"bxs:moon",class:"mode-icon moon"}),t[144]||(t[144]=(0,i.Lk)("span",null,"夜间",-1))],64))])]),(0,i.Lk)("button",{onClick:t[23]||(t[23]=(...e)=>wi.resetReader&&wi.resetReader(...e)),class:"reset-button"},"关闭")])]),Fi.showSearchBar?((0,i.uX)(),(0,i.CE)("div",Ie,[(0,i.Lk)("div",_e,[(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[24]||(t[24]=e=>Fi.searchQuery=e),onInput:t[25]||(t[25]=(...e)=>wi.onSearchInput&&wi.onSearchInput(...e)),type:"text",class:"search-input",placeholder:"搜索消息内容或发言者..."},null,544),[[s.Jo,Fi.searchQuery]]),Fi.searchQuery?((0,i.uX)(),(0,i.CE)("button",{key:0,onClick:t[26]||(t[26]=(...e)=>wi.clearSearch&&wi.clearSearch(...e)),class:"search-clear",title:"清除"},"✕")):(0,i.Q3)("",!0)]),(0,i.Lk)("div",Pe,[Fi.searchQuery?((0,i.uX)(),(0,i.CE)("span",Ne," 找到 "+(0,o.v_)(wi.filteredMessages.length)+" 条匹配 ",1)):(0,i.Q3)("",!0)])])):(0,i.Q3)("",!0),Fi.showTagFilterManager?((0,i.uX)(),(0,i.CE)("div",Re,[(0,i.Lk)("div",$e,[t[145]||(t[145]=(0,i.Lk)("h2",null,"标签过滤（优先于正则）",-1)),(0,i.Lk)("div",Oe,[(0,i.Lk)("button",{onClick:t[27]||(t[27]=(...e)=>wi.addNewTagFilter&&wi.addNewTagFilter(...e)),class:"btn btn-primary"},"添加过滤")])]),Fi.tagFilterForm.id?((0,i.uX)(),(0,i.CE)("div",Xe,[(0,i.Lk)("div",Ue,[t[146]||(t[146]=(0,i.Lk)("label",null,"过滤器名称",-1)),(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[28]||(t[28]=e=>Fi.tagFilterForm.name=e),type:"text",placeholder:"如：移除思维链"},null,512),[[s.Jo,Fi.tagFilterForm.name]])]),(0,i.Lk)("div",He,[t[147]||(t[147]=(0,i.Lk)("label",null,"标签名（不含尖括号）",-1)),(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[29]||(t[29]=e=>Fi.tagFilterForm.tagName=e),type:"text",placeholder:"如：think 或 thinking"},null,512),[[s.Jo,Fi.tagFilterForm.tagName]]),t[148]||(t[148]=(0,i.Lk)("div",{class:"form-hint"},"支持多个标签，用逗号分隔，如：think,thinking,disclaimer",-1))]),(0,i.Lk)("div",Ae,[t[150]||(t[150]=(0,i.Lk)("label",null,"过滤模式",-1)),(0,i.bo)((0,i.Lk)("select",{"onUpdate:modelValue":t[30]||(t[30]=e=>Fi.tagFilterForm.mode=e),class:"form-select"},[...t[149]||(t[149]=[(0,i.Lk)("option",{value:"remove"},"删除这些标签及其内容",-1),(0,i.Lk)("option",{value:"keep"},"只保留这些标签内的内容",-1),(0,i.Lk)("option",{value:"unwrap"},"移除标签但保留内容",-1)])],512),[[s.u1,Fi.tagFilterForm.mode]])]),(0,i.Lk)("div",ze,[(0,i.Lk)("label",null,[(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[31]||(t[31]=e=>Fi.tagFilterForm.disabled=e),type:"checkbox"},null,512),[[s.lH,Fi.tagFilterForm.disabled]]),t[151]||(t[151]=(0,i.eW)(" 禁用此过滤器 ",-1))])]),(0,i.Lk)("div",Je,[(0,i.Lk)("button",{onClick:t[32]||(t[32]=(...e)=>wi.cancelEditTagFilter&&wi.cancelEditTagFilter(...e)),class:"btn btn-secondary"},"取消"),(0,i.Lk)("button",{onClick:t[33]||(t[33]=(...e)=>wi.saveTagFilter&&wi.saveTagFilter(...e)),class:"btn btn-primary"},"保存")])])):(0,i.Q3)("",!0),(0,i.Lk)("div",je,[Fi.tagFilters.length?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",We,' 暂无标签过滤器，点击"添加过滤"来创建 ')),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.tagFilters,(e,t)=>((0,i.uX)(),(0,i.CE)("div",{key:e.id,class:(0,o.C4)(["script-item",{disabled:e.disabled}])},[(0,i.Lk)("div",Ye,[(0,i.Lk)("div",Be,(0,o.v_)(e.name),1),(0,i.Lk)("div",Qe,(0,o.v_)("remove"===e.mode?"删除":"keep"===e.mode?"只保留":"解包")+": <"+(0,o.v_)(e.tagName)+"> ",1)]),(0,i.Lk)("div",Ge,[(0,i.Lk)("button",{onClick:e=>wi.moveTagFilterUp(t),disabled:0===t,class:"btn-icon",title:"上移"},"↑",8,Ve),(0,i.Lk)("button",{onClick:e=>wi.moveTagFilterDown(t),disabled:t===Fi.tagFilters.length-1,class:"btn-icon",title:"下移"},"↓",8,Ke),(0,i.Lk)("button",{onClick:t=>wi.toggleTagFilter(e),class:(0,o.C4)(["btn-toggle",{active:!e.disabled}])},(0,o.v_)(e.disabled?"已禁用":"已启用"),11,qe),(0,i.Lk)("button",{onClick:t=>wi.editTagFilter(e),class:"btn-icon",title:"编辑"},"✎",8,Ze),(0,i.Lk)("button",{onClick:t=>wi.deleteTagFilter(e.id),class:"btn-icon btn-danger",title:"删除"},"✕",8,et)])],2))),128))])])):(0,i.Q3)("",!0),Fi.showRegexManager?((0,i.uX)(),(0,i.CE)("div",tt,[(0,i.Lk)("div",at,[t[152]||(t[152]=(0,i.Lk)("h2",null,"正则脚本管理",-1)),(0,i.Lk)("div",st,[(0,i.Lk)("button",{onClick:t[34]||(t[34]=(...e)=>wi.importScripts&&wi.importScripts(...e)),class:"btn btn-secondary"},"导入JSON"),(0,i.Lk)("button",{onClick:t[35]||(t[35]=(...e)=>wi.importFromCardOrPreset&&wi.importFromCardOrPreset(...e)),class:"btn btn-secondary"},"从角色卡/预设导入"),(0,i.Lk)("button",{onClick:t[36]||(t[36]=(...e)=>wi.exportScripts&&wi.exportScripts(...e)),class:"btn btn-secondary",disabled:!Fi.regexScripts.length},"导出",8,it),(0,i.Lk)("button",{onClick:t[37]||(t[37]=(...e)=>wi.addNewScript&&wi.addNewScript(...e)),class:"btn btn-primary"},"添加脚本")])]),Fi.scriptForm.id?((0,i.uX)(),(0,i.CE)("div",ot,[(0,i.Lk)("div",nt,[t[153]||(t[153]=(0,i.Lk)("label",null,"脚本名称",-1)),(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[38]||(t[38]=e=>Fi.scriptForm.scriptName=e),type:"text",placeholder:"如：移除思维链内容"},null,512),[[s.Jo,Fi.scriptForm.scriptName]])]),(0,i.Lk)("div",rt,[t[154]||(t[154]=(0,i.Lk)("label",null,"正则表达式",-1)),(0,i.bo)((0,i.Lk)("textarea",{"onUpdate:modelValue":t[39]||(t[39]=e=>Fi.scriptForm.findRegex=e),placeholder:"如：/(<think>[\\s\\S]*?</think>)/gs",rows:"3"},null,512),[[s.Jo,Fi.scriptForm.findRegex]]),t[155]||(t[155]=(0,i.Lk)("div",{class:"form-hint"},"支持格式：/pattern/flags 或直接输入模式（默认添加 g 标志）",-1))]),(0,i.Lk)("div",lt,[t[156]||(t[156]=(0,i.Lk)("label",null,"替换内容",-1)),(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[40]||(t[40]=e=>Fi.scriptForm.replaceString=e),type:"text",placeholder:"留空表示删除匹配内容"},null,512),[[s.Jo,Fi.scriptForm.replaceString]])]),(0,i.Lk)("div",ct,[(0,i.Lk)("label",null,[(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[41]||(t[41]=e=>Fi.scriptForm.disabled=e),type:"checkbox"},null,512),[[s.lH,Fi.scriptForm.disabled]]),t[157]||(t[157]=(0,i.eW)(" 禁用此脚本 ",-1))])]),(0,i.Lk)("div",dt,[(0,i.Lk)("button",{onClick:t[42]||(t[42]=(...e)=>wi.cancelEdit&&wi.cancelEdit(...e)),class:"btn btn-secondary"},"取消"),(0,i.Lk)("button",{onClick:t[43]||(t[43]=(...e)=>wi.saveScript&&wi.saveScript(...e)),class:"btn btn-primary"},"保存")])])):(0,i.Q3)("",!0),(0,i.Lk)("div",ht,[Fi.regexScripts.length?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",gt,' 暂无正则脚本，点击"添加脚本"或"导入"来创建 ')),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.regexScripts,(e,a)=>((0,i.uX)(),(0,i.CE)("div",{key:e.id,class:(0,o.C4)(["script-item",{disabled:e.disabled,dragging:Fi.dragIndex===a}]),draggable:"true",onDragstart:e=>wi.handleDragStart(a),onDragover:t[44]||(t[44]=(...e)=>wi.handleDragOver&&wi.handleDragOver(...e)),onDrop:e=>wi.handleDrop(e,a),onDragend:t[45]||(t[45]=(...e)=>wi.handleDragEnd&&wi.handleDragEnd(...e))},[t[158]||(t[158]=(0,i.Lk)("div",{class:"script-drag-handle"},"⋮⋮",-1)),(0,i.Lk)("div",pt,[(0,i.Lk)("div",mt,(0,o.v_)(e.scriptName),1),(0,i.Lk)("div",vt,(0,o.v_)(e.findRegex.substring(0,60))+(0,o.v_)(e.findRegex.length>60?"...":""),1)]),(0,i.Lk)("div",kt,[(0,i.Lk)("button",{onClick:e=>wi.moveScriptUp(a),disabled:0===a,class:"btn-icon",title:"上移"},"↑",8,bt),(0,i.Lk)("button",{onClick:e=>wi.moveScriptDown(a),disabled:a===Fi.regexScripts.length-1,class:"btn-icon",title:"下移"},"↓",8,yt),(0,i.Lk)("button",{onClick:t=>wi.toggleScript(e),class:(0,o.C4)(["btn-toggle",{active:!e.disabled}])},(0,o.v_)(e.disabled?"已禁用":"已启用"),11,ft),(0,i.Lk)("button",{onClick:t=>wi.editScript(e),class:"btn-icon",title:"编辑"},"✎",8,xt),(0,i.Lk)("button",{onClick:t=>wi.deleteScript(e.id),class:"btn-icon btn-danger",title:"删除"},"✕",8,St)])],42,ut))),128))])])):(0,i.Q3)("",!0),Fi.showFavoritesPanel?((0,i.uX)(),(0,i.CE)("div",Ct,[(0,i.Lk)("div",Lt,[t[159]||(t[159]=(0,i.Lk)("h2",{style:{margin:"0 0 10px 0","font-size":"1.1rem"}},"收藏夹",-1)),(0,i.Lk)("div",Ft,[(0,i.Lk)("div",wt,[(0,i.Lk)("button",{onClick:t[46]||(t[46]=(...e)=>wi.switchToCurrentFavorites&&wi.switchToCurrentFavorites(...e)),class:(0,o.C4)(["simple-tab",{active:!Fi.viewingGlobalFavorites}])}," 当前文件 ",2),(0,i.Lk)("button",{onClick:t[47]||(t[47]=(...e)=>wi.switchToGlobalFavorites&&wi.switchToGlobalFavorites(...e)),class:(0,o.C4)(["simple-tab",{active:Fi.viewingGlobalFavorites}])}," 全部文件 ",2)]),(0,i.Lk)("div",Mt,[Fi.viewingGlobalFavorites?((0,i.uX)(),(0,i.CE)("button",{key:1,onClick:t[51]||(t[51]=(...e)=>wi.exportGlobalFavorites&&wi.exportGlobalFavorites(...e)),class:"btn btn-primary btn-xs"},"导出全部")):((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[(0,i.Lk)("button",{onClick:t[48]||(t[48]=(...e)=>wi.triggerImportFavorites&&wi.triggerImportFavorites(...e)),class:"btn btn-secondary btn-xs"},"导入"),(0,i.Lk)("button",{onClick:t[49]||(t[49]=(...e)=>wi.exportFavorites&&wi.exportFavorites(...e)),class:"btn btn-secondary btn-xs",disabled:!Fi.favorites.length},"导出",8,Tt),(0,i.Lk)("button",{onClick:t[50]||(t[50]=(...e)=>wi.clearAllFavorites&&wi.clearAllFavorites(...e)),class:"btn btn-secondary btn-xs",disabled:!Fi.favorites.length},"清空",8,Dt)],64))])])]),Fi.viewingGlobalFavorites?((0,i.uX)(),(0,i.CE)("div",zt,[Fi.globalFavoritesList.length?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",Jt," 数据库中没有任何收藏记录 ")),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.globalFavoritesList,e=>((0,i.uX)(),(0,i.CE)("div",{key:e.fileName,style:{"margin-bottom":"15px"}},[(0,i.Lk)("div",jt,[(0,i.bF)(Mi,{icon:"bi:file-earmark-text"}),(0,i.eW)(" "+(0,o.v_)(e.fileName),1)]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e.items,a=>((0,i.uX)(),(0,i.CE)("div",{key:a.id,class:"favorite-item"},[(0,i.Lk)("div",Wt,[(0,i.Lk)("div",Yt,["message"===a.type?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[(0,i.bF)(Mi,{icon:"icon-park-twotone:copy",style:{"vertical-align":"-2px","margin-right":"2px"}}),t[163]||(t[163]=(0,i.Lk)("span",{style:{"font-weight":"bold"}},"楼层",-1))],64)):((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[(0,i.bF)(Mi,{icon:"ri:draft-line",style:{"vertical-align":"-2px","margin-right":"2px"}}),t[164]||(t[164]=(0,i.Lk)("span",{style:{"font-weight":"bold"}},"句子",-1))],64)),(0,i.Lk)("span",Bt,"#"+(0,o.v_)(a.messageIndex+1),1),e.fileName!==Fi.currentFileName?((0,i.uX)(),(0,i.CE)("span",Qt," 只读 ")):(0,i.Q3)("",!0)]),(0,i.Lk)("div",Gt,(0,o.v_)(a.text.substring(0,80))+"...",1)]),(0,i.Lk)("div",Vt,[(0,i.Lk)("button",{onClick:(0,s.D$)(e=>wi.copyFavorite(a),["stop"]),class:"btn-icon",title:"复制"},[(0,i.bF)(Mi,{icon:"icon-park-twotone:copy"})],8,Kt),(0,i.Lk)("button",{onClick:(0,s.D$)(t=>wi.deleteGlobalFavorite(e.fileName,a.id),["stop"]),class:"btn-icon btn-danger",title:"删除"},"✕",8,qt)])]))),128))]))),128))])):((0,i.uX)(),(0,i.CE)("div",Et,[Fi.favorites.length?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",It,[...t[160]||(t[160]=[(0,i.eW)(" 当前文件暂无收藏 ",-1),(0,i.Lk)("br",null,null,-1),(0,i.Lk)("span",{style:{"font-size":"0.8em",opacity:"0.7"}},"（选中正文文字即可收藏句子，或点击楼层右上角收藏整楼）",-1)])])),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.favorites,e=>((0,i.uX)(),(0,i.CE)("div",{key:e.id,class:"favorite-item",onClick:t=>wi.navigateToFavorite(e),title:"点击跳转到对应楼层"},[(0,i.Lk)("div",Pt,[(0,i.Lk)("div",Nt,["message"===e.type?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[(0,i.bF)(Mi,{icon:"icon-park-twotone:copy",style:{"vertical-align":"-2px","margin-right":"2px"}}),t[161]||(t[161]=(0,i.Lk)("span",{style:{"font-weight":"bold","margin-right":"4px"}},"楼层",-1))],64)):((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[(0,i.bF)(Mi,{icon:"ri:draft-line",style:{"vertical-align":"-2px","margin-right":"2px"}}),t[162]||(t[162]=(0,i.Lk)("span",{style:{"font-weight":"bold","margin-right":"4px"}},"句子",-1))],64)),(0,i.Lk)("span",Rt,"#"+(0,o.v_)(e.messageIndex+1),1)]),(0,i.Lk)("div",$t,(0,o.v_)(e.text.substring(0,100))+(0,o.v_)(e.text.length>100?"...":""),1),(0,i.Lk)("div",Ot,[e.speaker?((0,i.uX)(),(0,i.CE)("span",Xt,(0,o.v_)(e.speaker),1)):(0,i.Q3)("",!0),(0,i.Lk)("span",null,(0,o.v_)(wi.formatFavoriteTime(e.createdAt)),1)])]),(0,i.Lk)("div",Ut,[(0,i.Lk)("button",{onClick:(0,s.D$)(t=>wi.copyFavorite(e),["stop"]),class:"btn-icon",title:"复制"},[(0,i.bF)(Mi,{icon:"icon-park-twotone:copy"})],8,Ht),(0,i.Lk)("button",{onClick:(0,s.D$)(t=>wi.deleteFavorite(e.id),["stop"]),class:"btn-icon btn-danger",title:"删除"},"✕",8,At)])],8,_t))),128))]))])):(0,i.Q3)("",!0),Fi.showStylePanel?((0,i.uX)(),(0,i.CE)("div",Zt,[(0,i.Lk)("div",ea,[t[165]||(t[165]=(0,i.Lk)("h2",null,"正文样式设置",-1)),(0,i.Lk)("div",ta,[(0,i.Lk)("button",{onClick:t[52]||(t[52]=(...e)=>wi.resetStyles&&wi.resetStyles(...e)),class:"btn btn-secondary"},"恢复默认")])]),(0,i.Lk)("div",aa,[(0,i.Lk)("div",sa,[t[167]||(t[167]=(0,i.Lk)("label",{class:"style-label"},"字体设置",-1)),(0,i.Lk)("div",ia,[(0,i.bo)((0,i.Lk)("select",{"onUpdate:modelValue":t[53]||(t[53]=e=>Fi.textStyles.fontFamily=e),onChange:t[54]||(t[54]=(...e)=>wi.saveStylesToStorage&&wi.saveStylesToStorage(...e)),class:"style-select"},[t[166]||(t[166]=(0,i.Fv)('<optgroup label="系统字体" data-v-75685e9c><option value="system" data-v-75685e9c>系统默认</option><option value="serif" data-v-75685e9c>宋体 / 衬线体</option><option value="sans-serif" data-v-75685e9c>黑体 / 无衬线体</option><option value="kaiti" data-v-75685e9c>楷体</option><option value="fangsong" data-v-75685e9c>仿宋</option><option value="monospace" data-v-75685e9c>等宽字体</option></optgroup><optgroup label="在线字体" data-v-75685e9c><option value="alegreya" data-v-75685e9c>Alegreya</option><option value="cangeryunhei" data-v-75685e9c>仓耳云黑</option><option value="huiwenmingchao" data-v-75685e9c>汇文明朝</option><option value="kongmingchao" data-v-75685e9c>空明朝（繁体/日文）</option><option value="pingxianzhensong" data-v-75685e9c>屏显臻宋</option><option value="wenyueminguofangsong" data-v-75685e9c>文悦民国仿宋</option></optgroup>',2)),Fi.customFonts.length?((0,i.uX)(),(0,i.CE)("optgroup",oa,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.customFonts,e=>((0,i.uX)(),(0,i.CE)("option",{key:e.id,value:"custom-"+e.id},(0,o.v_)(e.name),9,na))),128))])):(0,i.Q3)("",!0)],544),[[s.u1,Fi.textStyles.fontFamily]]),(0,i.Lk)("button",{onClick:t[55]||(t[55]=e=>Fi.showCustomFontDialog=!0),class:"btn btn-secondary btn-sm compact-btn",title:"导入字体"}," + 导入 ")])]),(0,i.Lk)("div",ra,[(0,i.Lk)("div",la,[(0,i.Lk)("label",ca,"字号 / "+(0,o.v_)(Fi.textStyles.fontSize)+"px",1),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":t[56]||(t[56]=e=>Fi.textStyles.fontSize=e),onInput:t[57]||(t[57]=(...e)=>wi.handleStyleChange&&wi.handleStyleChange(...e)),min:"12",max:"32",step:"1",class:"style-slider"},null,544),[[s.Jo,Fi.textStyles.fontSize,void 0,{number:!0}]])]),(0,i.Lk)("div",da,[(0,i.Lk)("label",ha,"行高 / "+(0,o.v_)(Fi.textStyles.lineHeight.toFixed(1)),1),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":t[58]||(t[58]=e=>Fi.textStyles.lineHeight=e),onInput:t[59]||(t[59]=(...e)=>wi.handleStyleChange&&wi.handleStyleChange(...e)),min:"1.2",max:"3",step:"0.1",class:"style-slider"},null,544),[[s.Jo,Fi.textStyles.lineHeight,void 0,{number:!0}]])]),(0,i.Lk)("div",ga,[(0,i.Lk)("label",ua,"段距 / "+(0,o.v_)(Fi.textStyles.paragraphSpacing.toFixed(1))+"em",1),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":t[60]||(t[60]=e=>Fi.textStyles.paragraphSpacing=e),onInput:t[61]||(t[61]=(...e)=>wi.handleStyleChange&&wi.handleStyleChange(...e)),min:"0",max:"2",step:"0.1",class:"style-slider"},null,544),[[s.Jo,Fi.textStyles.paragraphSpacing,void 0,{number:!0}]])]),(0,i.Lk)("div",pa,[(0,i.Lk)("label",ma,"字距 / "+(0,o.v_)(Fi.textStyles.letterSpacing)+"px",1),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":t[62]||(t[62]=e=>Fi.textStyles.letterSpacing=e),onInput:t[63]||(t[63]=(...e)=>wi.handleStyleChange&&wi.handleStyleChange(...e)),min:"-2",max:"10",step:"0.5",class:"style-slider"},null,544),[[s.Jo,Fi.textStyles.letterSpacing,void 0,{number:!0}]])])]),t[173]||(t[173]=(0,i.Lk)("hr",{class:"style-divider"},null,-1)),(0,i.Lk)("div",va,[(0,i.Lk)("div",ka,[t[168]||(t[168]=(0,i.Lk)("label",{class:"style-label"},"主要文本",-1)),(0,i.Lk)("div",ba,[(0,i.bo)((0,i.Lk)("input",{type:"color","onUpdate:modelValue":t[64]||(t[64]=e=>Fi.textStyles.textColor=e),onChange:t[65]||(t[65]=(...e)=>wi.saveStylesToStorage&&wi.saveStylesToStorage(...e)),class:"color-input"},null,544),[[s.Jo,Fi.textStyles.textColor]]),(0,i.Lk)("span",ya,(0,o.v_)(Fi.textStyles.textColor),1)])]),(0,i.Lk)("div",fa,[t[169]||(t[169]=(0,i.Lk)("label",{class:"style-label"},"斜体 (*text*)",-1)),(0,i.Lk)("div",xa,[(0,i.bo)((0,i.Lk)("input",{type:"color","onUpdate:modelValue":t[66]||(t[66]=e=>Fi.textStyles.italicColor=e),onChange:t[67]||(t[67]=(...e)=>wi.saveStylesToStorage&&wi.saveStylesToStorage(...e)),class:"color-input"},null,544),[[s.Jo,Fi.textStyles.italicColor]]),(0,i.Lk)("span",Sa,(0,o.v_)(Fi.textStyles.italicColor),1)])]),(0,i.Lk)("div",Ca,[t[170]||(t[170]=(0,i.Lk)("label",{class:"style-label"},"下划线 (<u>)",-1)),(0,i.Lk)("div",La,[(0,i.bo)((0,i.Lk)("input",{type:"color","onUpdate:modelValue":t[68]||(t[68]=e=>Fi.textStyles.underlineColor=e),onChange:t[69]||(t[69]=(...e)=>wi.saveStylesToStorage&&wi.saveStylesToStorage(...e)),class:"color-input"},null,544),[[s.Jo,Fi.textStyles.underlineColor]]),(0,i.Lk)("span",Fa,(0,o.v_)(Fi.textStyles.underlineColor),1)])]),(0,i.Lk)("div",wa,[t[171]||(t[171]=(0,i.Lk)("label",{class:"style-label"},"引用 ( > )",-1)),(0,i.Lk)("div",Ma,[(0,i.bo)((0,i.Lk)("input",{type:"color","onUpdate:modelValue":t[70]||(t[70]=e=>Fi.textStyles.quoteColor=e),onChange:t[71]||(t[71]=(...e)=>wi.saveStylesToStorage&&wi.saveStylesToStorage(...e)),class:"color-input"},null,544),[[s.Jo,Fi.textStyles.quoteColor]]),(0,i.Lk)("span",Ta,(0,o.v_)(Fi.textStyles.quoteColor),1)])])]),t[174]||(t[174]=(0,i.Lk)("hr",{class:"style-divider"},null,-1)),(0,i.Lk)("div",Da,[t[172]||(t[172]=(0,i.Lk)("label",{class:"style-label"},"对齐方式",-1)),(0,i.Lk)("div",Ea,[(0,i.Lk)("button",{onClick:t[72]||(t[72]=e=>wi.setTextAlign("left")),class:(0,o.C4)(["align-btn",{active:"left"===Fi.textStyles.textAlign}]),title:"左对齐"},"◧",2),(0,i.Lk)("button",{onClick:t[73]||(t[73]=e=>wi.setTextAlign("justify")),class:(0,o.C4)(["align-btn",{active:"justify"===Fi.textStyles.textAlign}]),title:"两端对齐"},"▣",2),(0,i.Lk)("button",{onClick:t[74]||(t[74]=e=>wi.setTextAlign("center")),class:(0,o.C4)(["align-btn",{active:"center"===Fi.textStyles.textAlign}]),title:"居中"},"◫",2)])])]),(0,i.Lk)("div",Ia,[t[176]||(t[176]=(0,i.Lk)("div",{class:"style-preview-label"},"预览效果：",-1)),(0,i.Lk)("div",{class:"style-preview-content",style:(0,o.Tr)(wi.getPreviewStyles())},[...t[175]||(t[175]=[(0,i.Lk)("p",null," 这是一段主要文本。通常用于描写环境、动作或是正常的对话内容。你可以通过这段文字来确认基础字色是否符合你的阅读习惯。 ",-1),(0,i.Lk)("p",null,[(0,i.Lk)("em",null,"*这是一段斜体文本。在很多场景下，它被用来表现角色的内心独白、潜意识的想法，或者仅仅是为了表示某种特殊的强调语气。*")],-1),(0,i.Lk)("p",null,[(0,i.eW)(" 接着是特殊的标记内容，请注意这里有一段 "),(0,i.Lk)("u",null,"下划线文本"),(0,i.eW)("。这种格式常用于信件中的重点、告示牌上的文字，或者特殊的线索提示。 ")],-1),(0,i.Lk)("blockquote",null,[(0,i.eW)(" “这是一段引用文本。"),(0,i.Lk)("br"),(0,i.eW)(" 它通常用于展示书信内容、回忆的片段、书籍摘录或者是诗歌。"),(0,i.Lk)("br"),(0,i.eW)(" 请检查这段文字的颜色以及左侧引用线的颜色是否清晰。” ")],-1)])],4)]),Fi.customFonts.length?((0,i.uX)(),(0,i.CE)("div",_a,[t[177]||(t[177]=(0,i.Lk)("div",{class:"style-label"},"已导入的自定义字体",-1)),(0,i.Lk)("div",Pa,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.customFonts,e=>((0,i.uX)(),(0,i.CE)("div",{key:e.id,class:"custom-font-item"},[(0,i.Lk)("span",Na,(0,o.v_)(e.name),1),(0,i.Lk)("button",{onClick:t=>wi.deleteCustomFont(e.id),class:"btn-icon btn-danger",title:"删除"},"✕",8,Ra)]))),128))])])):(0,i.Q3)("",!0)])):(0,i.Q3)("",!0),Fi.showCustomFontDialog?((0,i.uX)(),(0,i.CE)("div",{key:5,class:"modal-overlay",onClick:t[81]||(t[81]=(0,s.D$)(e=>Fi.showCustomFontDialog=!1,["self"]))},[(0,i.Lk)("div",$a,[(0,i.Lk)("div",Oa,[t[178]||(t[178]=(0,i.Lk)("h3",null,"导入自定义字体",-1)),(0,i.Lk)("button",{onClick:t[75]||(t[75]=e=>Fi.showCustomFontDialog=!1),class:"modal-close"},"✕")]),(0,i.Lk)("div",Xa,[(0,i.Lk)("div",Ua,[t[179]||(t[179]=(0,i.Lk)("label",null,[(0,i.eW)("字体名称 "),(0,i.Lk)("span",{class:"required"},"*")],-1)),(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[76]||(t[76]=e=>Fi.customFontForm.name=e),type:"text",placeholder:"给字体起个名字",class:"form-input"},null,512),[[s.Jo,Fi.customFontForm.name]])]),(0,i.Lk)("div",Ha,[(0,i.Lk)("div",Aa,[t[180]||(t[180]=(0,i.Lk)("div",{class:"import-method-header"},"方式一：从URL导入",-1)),(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t[77]||(t[77]=e=>Fi.customFontForm.url=e),type:"text",placeholder:"输入字体文件的URL（支持 ttf/otf/woff/woff2）",class:"form-input",disabled:!!Fi.customFontForm.file},null,8,za),[[s.Jo,Fi.customFontForm.url]])]),t[182]||(t[182]=(0,i.Lk)("div",{class:"import-divider"},"或",-1)),(0,i.Lk)("div",Ja,[t[181]||(t[181]=(0,i.Lk)("div",{class:"import-method-header"},"方式二：从文件导入",-1)),(0,i.Lk)("input",{ref:"fontFileInput",type:"file",accept:".ttf,.otf,.woff,.woff2",onChange:t[78]||(t[78]=(...e)=>wi.handleFontFileSelect&&wi.handleFontFileSelect(...e)),class:"form-file-input",disabled:!!Fi.customFontForm.url},null,40,ja),Fi.customFontForm.file?((0,i.uX)(),(0,i.CE)("div",Wa," 已选择: "+(0,o.v_)(Fi.customFontForm.file.name),1)):(0,i.Q3)("",!0)])]),t[183]||(t[183]=(0,i.Lk)("div",{class:"form-hint"},[(0,i.eW)(" 支持的格式：TTF、OTF、WOFF、WOFF2"),(0,i.Lk)("br"),(0,i.eW)(" 注意：通过文件导入的字体会转换为Base64存储在浏览器中 ")],-1))]),(0,i.Lk)("div",Ya,[(0,i.Lk)("button",{onClick:t[79]||(t[79]=(...e)=>wi.resetCustomFontForm&&wi.resetCustomFontForm(...e)),class:"btn btn-secondary"},"清空"),(0,i.Lk)("button",{onClick:t[80]||(t[80]=(...e)=>wi.addCustomFont&&wi.addCustomFont(...e)),class:"btn btn-primary"},"导入字体")])])])):(0,i.Q3)("",!0),Fi.highlightMenu.show?((0,i.uX)(),(0,i.CE)("div",{key:6,class:"highlight-menu",style:(0,o.Tr)({left:Fi.highlightMenu.x+"px",top:Fi.highlightMenu.y+"px"})},[(0,i.Lk)("button",{onClick:t[82]||(t[82]=(...e)=>wi.removeHighlightFromMenu&&wi.removeHighlightFromMenu(...e)),class:"selection-btn"},"✕ 取消划线")],4)):(0,i.Q3)("",!0),Fi.readingMode?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",{key:7,class:"messages-wrapper",style:(0,o.Tr)(wi.getContentStyles())},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(wi.paginatedMessages,(e,a)=>((0,i.uX)(),(0,i.CE)("div",{key:wi.currentRange.start+a,class:(0,o.C4)(["message-block",{"user-message":e.is_user}])},[(0,i.Lk)("div",Ba,[(0,i.Lk)("span",Qa,(0,o.v_)(e.name),1),(0,i.Lk)("div",Ga,[e.send_date?((0,i.uX)(),(0,i.CE)("span",Va,(0,o.v_)(e.send_date),1)):(0,i.Q3)("",!0),e.model?((0,i.uX)(),(0,i.CE)("span",Ka,(0,o.v_)(e.model),1)):(0,i.Q3)("",!0),(0,i.Lk)("button",{onClick:t=>wi.toggleFavoriteMessage(wi.getGlobalMessageIndex(a),e),class:(0,o.C4)(["edit-btn",{favorited:wi.isMessageFavorited(wi.getGlobalMessageIndex(a))}]),title:wi.isMessageFavorited(wi.getGlobalMessageIndex(a))?"取消收藏":"收藏楼层"},(0,o.v_)(wi.isMessageFavorited(wi.getGlobalMessageIndex(a))?"★":"☆"),11,qa),(0,i.Lk)("button",{onClick:e=>wi.toggleEditMessage(wi.getGlobalMessageIndex(a)),class:"edit-btn",title:Fi.editingMessageIndex===wi.getGlobalMessageIndex(a)?"取消编辑":"编辑消息"},(0,o.v_)(Fi.editingMessageIndex===wi.getGlobalMessageIndex(a)?"✕":"✎"),9,Za)])]),Fi.editingMessageIndex===wi.getGlobalMessageIndex(a)?((0,i.uX)(),(0,i.CE)("div",es,[(0,i.bo)((0,i.Lk)("textarea",{"onUpdate:modelValue":t[83]||(t[83]=e=>Fi.editingContent=e),class:"edit-textarea",rows:"10"},null,512),[[s.Jo,Fi.editingContent]]),(0,i.Lk)("div",ts,[(0,i.Lk)("button",{onClick:t[84]||(t[84]=(...e)=>wi.cancelEditMessage&&wi.cancelEditMessage(...e)),class:"btn btn-secondary"},"取消"),(0,i.Lk)("button",{onClick:t[85]||(t[85]=(...e)=>wi.saveEditMessage&&wi.saveEditMessage(...e)),class:"btn btn-primary"},"保存")])])):(0,i.Q3)("",!0),Fi.editingMessageIndex!==wi.getGlobalMessageIndex(a)?((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[wi.hasHTMLCodeBlock(wi.getMessageContent(e))?((0,i.uX)(),(0,i.CE)("div",{key:0,class:"message-content-mixed",style:(0,o.Tr)(wi.getContentStyles()),onMouseup:t=>wi.handleTextSelection(t,wi.getGlobalMessageIndex(a),e)},[(0,i.Lk)("div",{class:"message-content",style:(0,o.Tr)(wi.getContentStyles()),innerHTML:wi.renderContentWithHTMLPlaceholder(wi.getMessageContent(e),wi.getGlobalMessageIndex(a))},null,12,ss)],44,as)):wi.isFullHTML(wi.getMessageContent(e))?((0,i.uX)(),(0,i.CE)("div",is,[(0,i.Lk)("div",os,[t[184]||(t[184]=(0,i.Lk)("span",{class:"html-tag"},"HTML 文档",-1)),(0,i.Lk)("button",{onClick:e=>wi.toggleHTMLPreview(wi.getGlobalMessageIndex(a)),class:"preview-toggle"},(0,o.v_)(e.showPreview?"隐藏预览":"显示预览"),9,ns)]),e.showPreview?((0,i.uX)(),(0,i.CE)("iframe",{key:0,srcdoc:wi.getMessageContent(e),class:"html-iframe",sandbox:"allow-scripts allow-same-origin"},null,8,rs)):((0,i.uX)(),(0,i.CE)("pre",ls,(0,o.v_)(wi.getMessageContent(e)),1))])):((0,i.uX)(),(0,i.CE)("div",{key:2,class:"message-content",style:(0,o.Tr)(wi.getContentStyles()),innerHTML:wi.renderContent(wi.getMessageContent(e),wi.getGlobalMessageIndex(a)),onMouseup:t=>wi.handleTextSelection(t,wi.getGlobalMessageIndex(a),e)},null,44,cs))],64)):(0,i.Q3)("",!0),e.swipes&&e.swipes.length>1?((0,i.uX)(),(0,i.CE)("div",ds,[(0,i.Lk)("button",{onClick:e=>wi.prevSwipe(wi.getGlobalMessageIndex(a)),disabled:0===e.currentSwipeIndex,class:"swipe-btn",title:"上一条"}," ◀ ",8,hs),(0,i.Lk)("span",gs,(0,o.v_)(e.currentSwipeIndex+1)+" / "+(0,o.v_)(e.swipes.length),1),(0,i.Lk)("button",{onClick:e=>wi.nextSwipe(wi.getGlobalMessageIndex(a)),disabled:e.currentSwipeIndex===e.swipes.length-1,class:"swipe-btn",title:"下一条"}," ▶ ",8,us)])):(0,i.Q3)("",!0)],2))),128))],4)),Fi.readingMode?((0,i.uX)(),(0,i.CE)("div",{key:8,class:"reading-view",ref:"readingView",onClick:t[95]||(t[95]=(...e)=>wi.handleReadingClick&&wi.handleReadingClick(...e))},[(0,i.Lk)("div",{class:"reading-content",ref:"readingContentEl",style:(0,o.Tr)(wi.getReadingTransform()),innerHTML:Fi.readingFullHtml,onMouseup:t[86]||(t[86]=(...e)=>wi.onReadingMouseUp&&wi.onReadingMouseUp(...e)),onTouchstart:t[87]||(t[87]=(...e)=>wi.onReadingTouchStart&&wi.onReadingTouchStart(...e)),onTouchend:t[88]||(t[88]=(...e)=>wi.onReadingTouchEnd&&wi.onReadingTouchEnd(...e))},null,44,ps),(0,i.Lk)("div",{class:"reading-nav-left",onClick:t[89]||(t[89]=(...e)=>wi.readingPrevPage&&wi.readingPrevPage(...e))}),(0,i.Lk)("div",{class:"reading-nav-right",onClick:t[90]||(t[90]=(...e)=>wi.readingNextPage&&wi.readingNextPage(...e))}),(0,i.Lk)("div",{class:"reading-nav-center",onClick:t[91]||(t[91]=(...e)=>wi.toggleToolbar&&wi.toggleToolbar(...e))}),(0,i.Lk)("div",{class:(0,o.C4)(["reading-footer",{visible:Fi.toolbarVisible}])},[(0,i.Lk)("div",ms,[(0,i.Lk)("span",null,(0,o.v_)(Fi.readingCurrentPage)+" / "+(0,o.v_)(Fi.readingTotalPages)+" 页",1),(0,i.Lk)("span",vs,"楼层 "+(0,o.v_)(wi.getReadingFloorRange()),1)]),(0,i.Lk)("div",ks,[(0,i.Lk)("button",{onClick:t[92]||(t[92]=(...e)=>wi.readingPrevPage&&wi.readingPrevPage(...e)),disabled:Fi.readingCurrentPage<=1,class:"reading-btn"},"◀",8,bs),(0,i.Lk)("button",{onClick:t[93]||(t[93]=(...e)=>wi.toggleReadingMode&&wi.toggleReadingMode(...e)),class:"reading-btn reading-exit"},"退出"),(0,i.Lk)("button",{onClick:t[94]||(t[94]=(...e)=>wi.readingNextPage&&wi.readingNextPage(...e)),disabled:Fi.readingCurrentPage>=Fi.readingTotalPages,class:"reading-btn"},"▶",8,ys)])],2)],512)):(0,i.Q3)("",!0),Fi.readingMode?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",fs,[(0,i.Lk)("div",xs,[(0,i.eW)(" 显示第 "+(0,o.v_)(wi.currentRange.start)+"-"+(0,o.v_)(wi.currentRange.end)+" 条，共 "+(0,o.v_)(wi.filteredMessages.length)+" 条 ",1),Fi.searchQuery?((0,i.uX)(),(0,i.CE)("span",Ss,"（已过滤）")):(0,i.Q3)("",!0)]),(0,i.Lk)("div",Cs,[(0,i.Lk)("button",{onClick:t[96]||(t[96]=e=>wi.goToPage(1)),disabled:1===Fi.currentPage,class:"page-btn",title:"首页"},"⟨⟨",8,Ls),(0,i.Lk)("button",{onClick:t[97]||(t[97]=(...e)=>wi.prevPage&&wi.prevPage(...e)),disabled:1===Fi.currentPage,class:"page-btn",title:"上一页"},"⟨",8,Fs),(0,i.Lk)("span",ws,(0,o.v_)(Fi.currentPage)+" / "+(0,o.v_)(wi.totalPages),1),(0,i.Lk)("button",{onClick:t[98]||(t[98]=(...e)=>wi.nextPage&&wi.nextPage(...e)),disabled:Fi.currentPage===wi.totalPages,class:"page-btn",title:"下一页"},"⟩",8,Ms),(0,i.Lk)("button",{onClick:t[99]||(t[99]=e=>wi.goToPage(wi.totalPages)),disabled:Fi.currentPage===wi.totalPages,class:"page-btn",title:"末页"},"⟩⟩",8,Ts),(0,i.bo)((0,i.Lk)("select",{"onUpdate:modelValue":t[100]||(t[100]=e=>Fi.pageSize=e),onChange:t[101]||(t[101]=(...e)=>wi.onPageSizeChange&&wi.onPageSizeChange(...e)),class:"page-size-select"},[...t[185]||(t[185]=[(0,i.Lk)("option",{value:10},"10条/页",-1),(0,i.Lk)("option",{value:20},"20条/页",-1),(0,i.Lk)("option",{value:50},"50条/页",-1),(0,i.Lk)("option",{value:100},"100条/页",-1)])],544),[[s.u1,Fi.pageSize,void 0,{number:!0}]])])]))])),Fi.selectionMenu.show?((0,i.uX)(),(0,i.CE)("div",{key:3,class:"selection-menu",style:(0,o.Tr)({left:Fi.selectionMenu.x+"px",top:Fi.selectionMenu.y+"px"})},[(0,i.Lk)("button",{onClick:t[102]||(t[102]=(...e)=>wi.favoriteSelectedText&&wi.favoriteSelectedText(...e)),class:"selection-btn"},"☆ 收藏"),(0,i.Lk)("button",{onClick:t[103]||(t[103]=(...e)=>wi.highlightSelectedText&&wi.highlightSelectedText(...e)),class:"selection-btn"},"🖍 划线"),(0,i.Lk)("button",{onClick:t[104]||(t[104]=(...e)=>wi.copySelectedText&&wi.copySelectedText(...e)),class:"selection-btn"},[(0,i.bF)(Mi,{icon:"icon-park-twotone:copy",style:{"vertical-align":"-2px","margin-right":"2px"}}),t[186]||(t[186]=(0,i.eW)(" 复制 ",-1))])],4)):(0,i.Q3)("",!0),Fi.exportDialog.show?((0,i.uX)(),(0,i.CE)("div",{key:4,class:"export-dialog-overlay",onClick:t[112]||(t[112]=(0,s.D$)((...e)=>wi.closeExportDialog&&wi.closeExportDialog(...e),["self"]))},[(0,i.Lk)("div",Ds,[(0,i.Lk)("div",Es,[t[187]||(t[187]=(0,i.Lk)("h3",null,"导出楼层范围",-1)),(0,i.Lk)("button",{onClick:t[105]||(t[105]=(...e)=>wi.closeExportDialog&&wi.closeExportDialog(...e)),class:"btn-icon"},"✕")]),(0,i.Lk)("div",Is,[(0,i.Lk)("div",_s,[(0,i.Lk)("div",Ps,[(0,i.Lk)("div",Ns,[t[188]||(t[188]=(0,i.Lk)("label",null,"起始楼层",-1)),(0,i.bo)((0,i.Lk)("input",{type:"number","onUpdate:modelValue":t[106]||(t[106]=e=>Fi.exportDialog.startFloor=e),min:1,max:wi.filteredMessages.length,class:"range-input"},null,8,Rs),[[s.Jo,Fi.exportDialog.startFloor,void 0,{number:!0}]])]),t[190]||(t[190]=(0,i.Lk)("span",{class:"range-separator"},"至",-1)),(0,i.Lk)("div",$s,[t[189]||(t[189]=(0,i.Lk)("label",null,"结束楼层",-1)),(0,i.bo)((0,i.Lk)("input",{type:"number","onUpdate:modelValue":t[107]||(t[107]=e=>Fi.exportDialog.endFloor=e),min:1,max:wi.filteredMessages.length,class:"range-input"},null,8,Os),[[s.Jo,Fi.exportDialog.endFloor,void 0,{number:!0}]])])]),(0,i.Lk)("div",Xs," 共 "+(0,o.v_)(wi.filteredMessages.length)+" 条消息，将导出 "+(0,o.v_)(wi.getExportCount())+" 条 ",1)]),(0,i.Lk)("div",Us,[(0,i.Lk)("label",Hs,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[108]||(t[108]=e=>Fi.exportDialog.includeName=e)},null,512),[[s.lH,Fi.exportDialog.includeName]]),t[191]||(t[191]=(0,i.eW)(" 包含发言者名称 ",-1))]),(0,i.Lk)("label",As,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[109]||(t[109]=e=>Fi.exportDialog.includeTime=e)},null,512),[[s.lH,Fi.exportDialog.includeTime]]),t[192]||(t[192]=(0,i.eW)(" 包含发送时间 ",-1))])]),(0,i.Lk)("div",zs,[t[193]||(t[193]=(0,i.Lk)("div",{class:"export-preview-label"},"预览（前 3 条）：",-1)),(0,i.Lk)("pre",Js,(0,o.v_)(wi.getExportPreview()),1)])]),(0,i.Lk)("div",js,[(0,i.Lk)("button",{onClick:t[110]||(t[110]=(...e)=>wi.closeExportDialog&&wi.closeExportDialog(...e)),class:"btn btn-secondary"},"取消"),(0,i.Lk)("button",{onClick:t[111]||(t[111]=(...e)=>wi.doExportRange&&wi.doExportRange(...e)),class:"btn btn-primary"},"导出 TXT")])])])):(0,i.Q3)("",!0),Fi.showIntimacyModal?((0,i.uX)(),(0,i.CE)("div",{key:5,class:"modal-overlay",onClick:t[118]||(t[118]=(0,s.D$)(e=>Fi.showIntimacyModal=!1,["self"]))},[(0,i.Lk)("div",Ws,[(0,i.Lk)("div",Ys,[(0,i.Lk)("h3",null,[(0,i.bF)(Mi,{icon:"bxs:heart",style:{color:"#e91e63","margin-right":"8px"}}),t[194]||(t[194]=(0,i.eW)(" 情感档案 ",-1))]),(0,i.Lk)("button",{onClick:t[113]||(t[113]=e=>Fi.showIntimacyModal=!1),class:"modal-close"},"✕")]),(0,i.Lk)("div",Bs,[(0,i.Lk)("div",Qs,[(0,i.Lk)("div",Gs,[t[195]||(t[195]=(0,i.Lk)("div",{class:"stat-label"},"相识日期",-1)),(0,i.Lk)("div",Vs,(0,o.v_)(Fi.intimacyData.firstDate||"N/A"),1),(0,i.Lk)("div",Ks,"距今 "+(0,o.v_)(Fi.intimacyData.daysSince)+" 天",1)]),(0,i.Lk)("div",qs,[t[197]||(t[197]=(0,i.Lk)("div",{class:"stat-label"},"活跃天数",-1)),(0,i.Lk)("div",Zs,[(0,i.eW)((0,o.v_)(Fi.intimacyData.activeDays)+" ",1),t[196]||(t[196]=(0,i.Lk)("span",{class:"unit"},"天",-1))]),t[198]||(t[198]=(0,i.Lk)("div",{class:"stat-sub"},"累计陪伴",-1))]),(0,i.Lk)("div",ei,[t[199]||(t[199]=(0,i.Lk)("div",{class:"stat-label"},"消息总数",-1)),(0,i.Lk)("div",ti,(0,o.v_)(Fi.intimacyData.totalMessages),1),(0,i.Lk)("div",ai,(0,o.v_)((Fi.intimacyData.totalChars/1e4).toFixed(1))+"万 字",1)]),(0,i.Lk)("div",si,[t[200]||(t[200]=(0,i.Lk)("div",{class:"stat-label"},"重Roll次数",-1)),(0,i.Lk)("div",ii,(0,o.v_)(Fi.intimacyData.totalRerolls),1),t[201]||(t[201]=(0,i.Lk)("div",{class:"stat-sub"},"再空回截断八股试试呢",-1))])]),(0,i.Lk)("div",oi,[t[206]||(t[206]=(0,i.Fv)('<div class="calendar-header-row" data-v-75685e9c><h4 data-v-75685e9c>陪伴日历</h4><div class="heatmap-legend" data-v-75685e9c><span data-v-75685e9c>少</span><span class="legend-item level-1" data-v-75685e9c></span><span class="legend-item level-2" data-v-75685e9c></span><span class="legend-item level-3" data-v-75685e9c></span><span class="legend-item level-4" data-v-75685e9c></span><span data-v-75685e9c>多</span></div></div>',1)),Fi.intimacyData.calendarMonths.length>0?((0,i.uX)(),(0,i.CE)("div",ni,[(0,i.Lk)("div",ri,[(0,i.Lk)("button",{onClick:t[114]||(t[114]=(...e)=>wi.prevMonth&&wi.prevMonth(...e)),disabled:Fi.currentMonthIndex>=Fi.intimacyData.calendarMonths.length-1,class:"nav-btn",title:"上个月"},"◀",8,li),(0,i.Lk)("div",ci,(0,o.v_)(Fi.intimacyData.calendarMonths[Fi.currentMonthIndex].year)+"年 "+(0,o.v_)(Fi.intimacyData.calendarMonths[Fi.currentMonthIndex].month)+"月 ",1),(0,i.Lk)("button",{onClick:t[115]||(t[115]=(...e)=>wi.nextMonth&&wi.nextMonth(...e)),disabled:Fi.currentMonthIndex<=0,class:"nav-btn",title:"下个月"},"▶",8,di)]),(0,i.Lk)("div",hi,[(0,i.Lk)("div",gi,[t[202]||(t[202]=(0,i.Fv)('<div class="weekday-header" data-v-75685e9c>日</div><div class="weekday-header" data-v-75685e9c>一</div><div class="weekday-header" data-v-75685e9c>二</div><div class="weekday-header" data-v-75685e9c>三</div><div class="weekday-header" data-v-75685e9c>四</div><div class="weekday-header" data-v-75685e9c>五</div><div class="weekday-header" data-v-75685e9c>六</div>',7)),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.intimacyData.calendarMonths[Fi.currentMonthIndex].paddingStart,e=>((0,i.uX)(),(0,i.CE)("div",{key:"pad-start-"+e,class:"day-cell padding"}))),128)),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Fi.intimacyData.calendarMonths[Fi.currentMonthIndex].days,e=>((0,i.uX)(),(0,i.CE)("div",{key:e.dateStr,class:(0,o.C4)(["day-cell",{"has-data":e.count>0}]),style:(0,o.Tr)({backgroundColor:e.bgStyle}),onMouseenter:t=>wi.showDayTooltip(t,e),onMousemove:t[116]||(t[116]=e=>wi.moveDayTooltip(e)),onMouseleave:t[117]||(t[117]=(...e)=>wi.hideDayTooltip&&wi.hideDayTooltip(...e))},[(0,i.Lk)("span",pi,(0,o.v_)(e.dayNum),1)],46,ui))),128))])]),(0,i.Lk)("div",mi,[(0,i.Lk)("div",vi,[t[203]||(t[203]=(0,i.Lk)("span",{class:"f-label"},"本月消息",-1)),(0,i.Lk)("span",ki,(0,o.v_)(Fi.intimacyData.calendarMonths[Fi.currentMonthIndex].totalCount),1)]),t[205]||(t[205]=(0,i.Lk)("div",{class:"footer-divider"},null,-1)),(0,i.Lk)("div",bi,[t[204]||(t[204]=(0,i.Lk)("span",{class:"f-label"},"本月字数",-1)),(0,i.Lk)("span",yi,(0,o.v_)(Fi.intimacyData.calendarMonths[Fi.currentMonthIndex].totalChars),1)])])])):((0,i.uX)(),(0,i.CE)("div",fi," 暂无日历数据 "))])])])])):(0,i.Q3)("",!0),(0,i.bo)((0,i.Lk)("div",{class:"custom-tooltip",style:(0,o.Tr)({left:Fi.tooltip.x+"px",top:Fi.tooltip.y+"px"})},[(0,i.Lk)("div",xi,(0,o.v_)(Fi.tooltip.dateStr),1),(0,i.Lk)("div",Si,[(0,i.bF)(Mi,{icon:"pepicons-pencil:letter",class:"tooltip-icon"}),(0,i.Lk)("span",null,(0,o.v_)(Fi.tooltip.count)+" 条消息",1)]),(0,i.Lk)("div",Ci,[(0,i.bF)(Mi,{icon:"ri:draft-line",class:"tooltip-icon"}),(0,i.Lk)("span",null,(0,o.v_)(Fi.tooltip.chars)+" 字",1)])],4),[[s.aG,Fi.tooltip.show]])],2)}a(4114),a(6573),a(8100),a(7936),a(116),a(7588),a(1701),a(3579),a(3110),a(9577),a(8335),a(1549),a(9797),a(9631),a(5623),a(4979),a(4603),a(7566),a(8721);var Fi=a(23),wi=a(9418),Mi=a(2321),Ti=a(1710),Di=a.n(Ti),Ei={name:"STReader",components:{Icon:Mi.In},data(){return{viewMode:"home",loadingStatus:"",zipFileCache:null,fromDashboard:!1,dashboardSearch:"",dashboardData:{totalFiles:0,totalEffectiveCN:0,totalTurns:0,totalRerolls:0,groups:{}},isDarkMode:!1,metadata:{},messages:[],rawData:[],dashboardCalendar:{months:[],currentMonthIdx:0,totalMessages:0,activeDays:0},regexScripts:[],showRegexManager:!1,editingScript:null,scriptForm:{id:"",scriptName:"",findRegex:"",replaceString:"",disabled:!1},dragIndex:null,currentPage:1,pageSize:10,searchQuery:"",searchResults:[],currentSearchIndex:-1,showSearchBar:!1,editingMessageIndex:null,editingContent:"",tagFilters:[],showTagFilterManager:!1,editingTagFilter:null,tagFilterForm:{id:"",name:"",tagName:"",mode:"remove",disabled:!1},favorites:[],highlights:[],showFavoritesPanel:!1,selectionMenu:{show:!1,x:0,y:0,text:"",messageIndex:null},highlightMenu:{show:!1,x:0,y:0,highlightId:null},exportDialog:{show:!1,startFloor:1,endFloor:1,includeName:!0,includeTime:!0},showStylePanel:!1,textStyles:{fontFamily:"system",fontSize:16,lineHeight:1.8,paragraphSpacing:1,letterSpacing:0,textColor:"#1a1a1a",italicColor:"#1a1a1a",underlineColor:"#1a1a1a",quoteColor:"#1a1a1a",textAlign:"justify"},colorOptions:[{name:"默认黑",value:"#1a1a1a"},{name:"深灰",value:"#333333"},{name:"中灰",value:"#555555"},{name:"浅灰",value:"#666666"},{name:"棕色",value:"#5d4037"},{name:"深蓝",value:"#1a237e"}],customFonts:[],showCustomFontDialog:!1,customFontForm:{name:"",url:"",file:null},readingMode:!1,toolbarVisible:!1,readingCurrentPage:1,readingTotalPages:1,readingFullHtml:"",readingTouchStartX:0,readingTouchStartY:0,toolbarTimeout:null,windowWidth:0,resizeTimer:null,keepReadingPagePosition:!1,showIntimacyModal:!1,intimacyData:{firstDate:"",daysSince:0,activeDays:0,totalMessages:0,totalChars:0,totalRerolls:0,calendarMonths:[]},currentMonthIndex:0,tooltip:{show:!1,x:0,y:0,dateStr:"",count:0,chars:0},resizeObserver:null,currentFileName:"",calendarViewMode:"month",heatmapData:{},heatmapYears:[],currentHeatmapYear:null,viewingGlobalFavorites:!1,globalFavoritesList:[]}},computed:{filteredDashboardGroups(){const e=this.dashboardSearch.toLowerCase();if(!e)return this.dashboardData.groups;const t={};return Object.entries(this.dashboardData.groups).forEach(([a,s])=>{const i=a.toLowerCase().includes(e),o=s.filter(t=>t.fileName.toLowerCase().includes(e));i?t[a]=s:o.length>0&&(t[a]=o)}),t},filteredMessages(){if(!this.searchQuery.trim())return this.messages;const e=this.searchQuery.toLowerCase();return this.messages.filter((t,a)=>{const s=this.getMessageContent(t).toLowerCase(),i=(t.name||"").toLowerCase(),o=s.includes(e)||i.includes(e);return o&&(t._originalIndex=a),o})},totalPages(){return Math.ceil(this.filteredMessages.length/this.pageSize)},paginatedMessages(){const e=(this.currentPage-1)*this.pageSize,t=e+this.pageSize;return this.filteredMessages.slice(e,t)},currentRange(){const e=(this.currentPage-1)*this.pageSize+1,t=Math.min(this.currentPage*this.pageSize,this.filteredMessages.length);return{start:e,end:t}}},async mounted(){console.log("App mounted, viewMode:",this.viewMode),document.body.style.overflow="",this.loadScriptsFromStorage(),this.loadTagFiltersFromStorage(),this.loadFavoritesFromStorage(),this.loadHighlightsFromStorage(),this.loadStylesFromStorage(),this.loadDarkMode(),this.loadCustomFonts(),this.replaceHTMLPlaceholders(),document.addEventListener("mousedown",this.hideSelectionMenu),window.addEventListener("keydown",this.handleKeydown),console.log("开始尝试恢复会话...");try{const e=await this.getFromDB("currentSession");if(e){if(console.log("找到缓存的会话:",e.type,e.fileName),this.loadingStatus="正在恢复上次的记录...","single"===e.type)e.content?(this.parseJSONL(e.content),this.viewMode="reader",this.fromDashboard=!1,e.metadata&&(this.metadata=e.metadata),console.log("单文件恢复成功")):console.warn("缓存数据中缺少 content 字段"),e.fileName&&(this.currentFileName=e.fileName,await this.loadFavoritesFromStorage());else if("dashboard"===e.type&&e.dashboardData){if(this.dashboardData=e.dashboardData,e.blob){const t=await Di().loadAsync(e.blob);this.zipFileCache=t}console.log("正在重新计算仪表盘日历视图...");const t={};Object.values(this.dashboardData.groups).forEach(e=>{e.forEach(e=>{e.dateMap&&Object.entries(e.dateMap).forEach(([e,a])=>{t[e]||(t[e]={count:0,chars:0}),"number"===typeof a?t[e].count+=a:(t[e].count+=a.count,t[e].chars+=a.chars||0)})})}),this.generateDashboardCalendarData(t),this.viewMode="dashboard",console.log("仪表盘恢复成功，日历已重绘")}this.loadingStatus=""}else console.log("IndexedDB 中没有找到 currentSession，保持在首页。")}catch(e){console.error("自动恢复会话时出错:",e),this.loadingStatus=""}},updated(){this.replaceHTMLPlaceholders(),document.addEventListener("mousedown",this.hideHighlightMenu),document.addEventListener("click",this.onHighlightClick)},beforeUnmount(){document.removeEventListener("mousedown",this.hideSelectionMenu),document.removeEventListener("mousedown",this.hideHighlightMenu),document.removeEventListener("click",this.onHighlightClick),window.removeEventListener("resize",this.handleResize),window.removeEventListener("keydown",this.handleKeydown),document.body.style.overflow="",this.toolbarTimeout&&clearTimeout(this.toolbarTimeout),this.resizeTimer&&clearTimeout(this.resizeTimer)},methods:{async handleZipUpload(e){const t=e.target.files[0];if(t){this.loadingStatus="正在解析压缩包，请稍候...";try{const e=await Di().loadAsync(t);this.zipFileCache=e;const s={totalFiles:0,totalEffectiveCN:0,totalTurns:0,totalRerolls:0,groups:{}},i=[];e.forEach((e,t)=>{if(t.dir||t.name.startsWith("__")||t.name.includes(".DS_Store")||!t.name.endsWith(".jsonl"))return;const a=t.async("text").then(e=>{const a=this.analyzeJsonlFast(e,t.name);if(a){s.totalFiles++,s.totalEffectiveCN+=a.effectiveCN,s.totalTurns+=a.totalTurns,s.totalRerolls+=a.rerolls;const e=a.characterName||"未知角色";s.groups[e]||(s.groups[e]=[]),s.groups[e].push(a)}});i.push(a)}),await Promise.all(i);const o={};Object.keys(s.groups).forEach(e=>{const t=s.groups[e];t.sort((e,t)=>t.fileName.localeCompare(e.fileName)),t.forEach(e=>{e.dateMap&&Object.entries(e.dateMap).forEach(([e,t])=>{o[e]||(o[e]={count:0,chars:0}),o[e].count+=t.count,o[e].chars+=t.chars})})}),this.generateDashboardCalendarData(o),this.dashboardData=s,this.viewMode="dashboard",this.loadingStatus="";try{await this.saveToDB("currentSession",{type:"dashboard",fileName:t.name,blob:t,dashboardData:JSON.parse(JSON.stringify(this.dashboardData)),dashboardCalendar:JSON.parse(JSON.stringify(this.dashboardCalendar)),heatmapData:JSON.parse(JSON.stringify(this.heatmapData))}),console.log("ZIP数据已缓存")}catch(a){console.warn("ZIP缓存失败(可能文件太大):",a)}}catch(s){console.error("ZIP 解析失败:",s),alert("ZIP 解析失败: "+s.message),this.loadingStatus=""}}},analyzeJsonlFast(e,t){try{const s=e.trim().split("\n");if(0===s.length)return null;let i={};try{i=JSON.parse(s[0])}catch(a){return null}const o=i.character_name||"未命名",n=e.replace(/<think>[\s\S]*?<\/think>/gi,""),r=(n.match(/[\u4e00-\u9fa5]/g)||[]).length,l=Math.max(0,s.length-1);let c=0,d="未知日期";const h={};for(let e=1;e<s.length;e++){const t=s[e];if(t.includes('"send_date"')||t.includes('"swipes"'))try{const a=JSON.parse(t);if(e>1&&a.swipes&&a.swipes.length>1&&(c+=a.swipes.length-1),e>1&&a.send_date){const e=this.parseSTDate(a.send_date);if(e){const t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),o=`${t}-${s}-${i}`;h[o]||(h[o]={count:0,chars:0}),h[o].count+=1;const n=a.swipes&&a.swipes.length>0&&a.swipes[a.swipe_id||0]||a.mes;n&&(h[o].chars+=n.length),d=a.send_date}}else a.send_date&&(d=a.send_date)}catch(a){}}if("未知日期"!==d){const e=this.parseSTDate(d);e&&(d=`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()}`)}return{fileName:t,characterName:o,effectiveCN:r,totalTurns:l,rerolls:c,lastDate:d,dateMap:h}}catch(a){return console.warn("解析文件出错:",t,a),null}},async openChatFromDashboard(e){if(this.zipFileCache){this.loadingStatus="正在加载聊天记录...";try{const t=this.zipFileCache.file(e.fileName);if(!t)throw new Error("文件未找到");const a=await t.async("text");this.parseJSONL(a),this.currentFileName=e.fileName,await this.loadFavoritesFromStorage(),this.viewMode="reader",this.fromDashboard=!0,this.loadingStatus=""}catch(t){alert("加载失败: "+t.message),this.loadingStatus=""}}},backToDashboard(){this.viewMode="dashboard",this.resetReaderStateOnly()},generateDashboardCalendarData(e){const t=Object.keys(e).sort();if(0===t.length)return this.dashboardCalendar={months:[],currentMonthIdx:0,totalMessages:0,activeDays:0},this.heatmapData={},void(this.heatmapYears=[]);const a=e=>{const t=e.split(/[-/]/).map(Number);return 3!==t.length?new Date:new Date(t[0],t[1]-1,t[2])};let s=0;Object.values(e).forEach(e=>{const t="number"===typeof e?e:e.count;t>s&&(s=t)});const i=[248,187,208],o=[136,14,79],n=t[0],r=t[t.length-1],l=a(n),c=a(r),d=[];let h=l.getFullYear(),g=l.getMonth();const u=c.getFullYear(),p=c.getMonth();let m=0;while(h<u||h===u&&g<=p){const t=new Date(h,g+1,0).getDate(),a=new Date(h,g,1),n=a.getDay(),r=[];let l=0,c=0;for(let d=1;d<=t;d++){const t=String(g+1).padStart(2,"0"),a=String(d).padStart(2,"0"),n=`${h}-${t}-${a}`,u=e[n]||{count:0,chars:0};l+=u.count,c+=u.chars,m+=u.count,r.push({dayNum:d,dateStr:n,count:u.count,chars:u.chars,bgStyle:u.count>0?this.getGradientColor(u.count,s,i,o):""})}d.push({year:h,month:g+1,paddingStart:n,days:r,totalCount:l,totalChars:c}),11===g?(g=0,h++):g++}this.dashboardCalendar={months:d.reverse(),currentMonthIdx:0,totalMessages:m,activeDays:t.length};const v=a(t[0]),k=a(t[t.length-1]),b=v.getFullYear(),y=k.getFullYear(),f={},x=[];for(let S=b;S<=y;S++){x.push(S);const t=new Date(S,0,1),a=new Date(S,11,31),n=[];let r=new Array(7).fill(null),l=new Date(t);while(l<=a){const t=String(l.getMonth()+1).padStart(2,"0"),c=String(l.getDate()).padStart(2,"0"),d=`${S}-${t}-${c}`,h=l.getDay();let g=e[d];g||(g=e[`${S}/${t}/${c}`]),g=g||{count:0,chars:0};const u=g.count>0?this.getGradientColor(g.count,s,i,o):null;r[h]={dateStr:d,hasData:g.count>0,count:g.count,chars:g.chars||0,bgStyle:u};const p=l.getTime()===a.getTime();(6===h||p)&&(n.push(r),r=new Array(7).fill(null)),l.setDate(l.getDate()+1)}f[S]=n}this.heatmapData=f,this.heatmapYears=x,this.currentHeatmapYear=y},prevDashMonth(){this.dashboardCalendar.currentMonthIdx<this.dashboardCalendar.months.length-1&&this.dashboardCalendar.currentMonthIdx++},nextDashMonth(){this.dashboardCalendar.currentMonthIdx>0&&this.dashboardCalendar.currentMonthIdx--},prevHeatmapYear(){const e=this.heatmapYears.indexOf(this.currentHeatmapYear);e>0&&(this.currentHeatmapYear=this.heatmapYears[e-1])},nextHeatmapYear(){const e=this.heatmapYears.indexOf(this.currentHeatmapYear);e<this.heatmapYears.length-1&&(this.currentHeatmapYear=this.heatmapYears[e+1])},resetReaderStateOnly(){this.metadata={},this.messages=[],this.rawData=[],this.currentPage=1,this.searchQuery="",this.readingMode=!1,document.body.style.overflow=""},toggleDarkMode(){this.isDarkMode=!this.isDarkMode;const e=["#000000","#1a1a1a","#333333"],t="#e0e0e0",a="#bfbfbf",s="#888888";if(this.isDarkMode)(e.includes(this.textStyles.textColor)||this.textStyles.textColor===a)&&(this.textStyles.textColor=t),(e.includes(this.textStyles.italicColor)||this.textStyles.italicColor===a)&&(this.textStyles.italicColor=t),(e.includes(this.textStyles.underlineColor)||this.textStyles.underlineColor===a)&&(this.textStyles.underlineColor=t),(e.includes(this.textStyles.quoteColor)||this.textStyles.quoteColor===a||this.textStyles.quoteColor===s)&&(this.textStyles.quoteColor=t),document.body.style.backgroundColor="#121212";else{const e=[t,a,s];e.includes(this.textStyles.textColor)&&(this.textStyles.textColor="#1a1a1a"),e.includes(this.textStyles.italicColor)&&(this.textStyles.italicColor="#1a1a1a"),e.includes(this.textStyles.underlineColor)&&(this.textStyles.underlineColor="#1a1a1a"),e.includes(this.textStyles.quoteColor)&&(this.textStyles.quoteColor="#1a1a1a"),document.body.style.backgroundColor=""}this.saveStylesToStorage(),localStorage.setItem("st_reader_dark_mode",this.isDarkMode)},loadDarkMode(){const e=localStorage.getItem("st_reader_dark_mode");"true"===e&&(this.isDarkMode=!0,document.body.style.backgroundColor="#121212")},handleFileUpload(e){const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=async e=>{const a=e.target.result;this.parseJSONL(a),this.currentFileName=t.name,await this.loadFavoritesFromStorage(),this.viewMode="reader",this.fromDashboard=!1;try{await this.saveToDB("currentSession",{type:"single",fileName:t.name,content:a,metadata:JSON.parse(JSON.stringify(this.metadata))}),console.log("单文件已缓存")}catch(s){console.error("缓存失败",s)}},a.readAsText(t)},parseJSONL(e){const t=e.trim().split("\n");this.rawData=[],this.messages=[],this.metadata={},t.forEach((e,t)=>{try{const a=JSON.parse(e);if(0!==t||a.mes){let e=!1;!0!==a.is_user&&1!==a.is_user&&"true"!==a.is_user||(e=!0);let t=[];a.swipes&&Array.isArray(a.swipes)&&a.swipes.length>1&&(t=a.swipes);const s={name:a.name||"未知",is_user:e,mes:a.mes||"",send_date:a.send_date||null,model:a.extra?.model||null,force_avatar:a.force_avatar||null,showPreview:!1,swipes:t,currentSwipeIndex:a.swipe_id||0};this.messages.push(s)}else this.metadata=a}catch(a){console.error(`解析第 ${t+1} 行时出错:`,a)}})},hasHTMLCodeBlock(e){if(!e)return!1;const t=/```(?:html)?\s*([\s\S]*?)```/i,a=e.match(t);if(!a)return!1;const s=a[1].trim(),i=/<!DOCTYPE\s+html>/i.test(s),o=/<html[\s>]/i.test(s);return i&&o},extractHTMLFromCodeBlock(e){if(!e)return"";const t=/```(?:html)?\s*([\s\S]*?)```/i,a=e.match(t);return a?a[1].trim():""},renderContentWithoutCodeBlock(e){if(!e)return"";let t=this.applyTagFilters(e);t=this.applyRegexScripts(t);const a=t.replace(/```(?:html)?\s*[\s\S]*?```/gi,"").trim();return this.renderMarkdown(a)},renderContentWithHTMLPlaceholder(e,t){if(!e)return"";let a=this.applyTagFilters(e);a=this.applyRegexScripts(a);const s=this.extractHTMLFromCodeBlock(a);if(!s)return this.renderMarkdown(a);const i=btoa(unescape(encodeURIComponent(s))),o=`<div class="html-preview-placeholder" data-html-base64="${i}" data-message-idx="${t}"></div>`,n=a.replace(/```(?:html)?\s*[\s\S]*?```/gi,o);return this.renderMarkdown(n)},replaceHTMLPlaceholders(){const e=this.$el?.querySelectorAll(".html-preview-placeholder")||[];e.forEach(e=>{const t=e.getAttribute("data-html-base64");if(t&&e.parentNode)try{const a=decodeURIComponent(escape(atob(t))),s=document.createElement("iframe");s.className="html-iframe",s.setAttribute("sandbox","allow-scripts allow-same-origin"),s.srcdoc=a;const i=document.createElement("div");i.className="html-preview-section",i.appendChild(s),e.parentNode.replaceChild(i,e)}catch(a){console.error("替换HTML占位符失败:",a)}})},renderMarkdown(e){if(!e)return"";Fi.xI.setOptions({breaks:!0,gfm:!0,sanitize:!1,mangle:!1,headerIds:!1});let t=Fi.xI.parse(e);return t=wi.A.sanitize(t,this.getDOMPurifyConfig()),t},getDOMPurifyConfig(){return{ALLOWED_TAGS:["p","br","strong","em","u","del","code","pre","blockquote","h1","h2","h3","h4","h5","h6","ul","ol","li","a","img","span","div","b","i","s","strike","sub","sup","table","thead","tbody","tr","th","td","hr","details","summary","style","mark","small","big","abbr","cite","q","dl","dt","dd","figure","figcaption","main","section","article","header","footer","nav","aside","address","time","ruby","rt","rp","button","label","input","select","option","textarea","fieldset","legend","meter","progress","output","canvas","svg","path","circle","rect","line","polygon","polyline","g","defs","use","symbol","text","tspan"],ALLOWED_ATTR:["href","src","alt","title","class","style","width","height","align","target","rel","id","name","type","value","placeholder","disabled","readonly","checked","min","max","step","pattern","required","multiple","rows","cols","wrap","for","form","open","datetime","cite","download","d","fill","stroke","stroke-width","viewBox","xmlns","cx","cy","r","rx","ry","x","y","x1","y1","x2","y2","points","transform","opacity","font-size","text-anchor","onclick","onchange","oninput","data-floor"],ALLOW_DATA_ATTR:!0}},isFullHTML(e){if(!e)return!1;const t=e.trim();if(/^```/.test(t))return!1;const a=/<!DOCTYPE\s+html>/i.test(t),s=/<html[\s>]/i.test(t),i=/^<html[\s>]/i.test(t);return a&&s||i},toggleHTMLPreview(e){this.messages[e].showPreview=!this.messages[e].showPreview},getMessageContent(e){return e.swipes&&e.swipes.length>0&&e.swipes[e.currentSwipeIndex]||e.mes},prevSwipe(e){const t=this.messages[e];t.swipes&&t.currentSwipeIndex>0&&t.currentSwipeIndex--},nextSwipe(e){const t=this.messages[e];t.swipes&&t.currentSwipeIndex<t.swipes.length-1&&t.currentSwipeIndex++},getGlobalMessageIndex(e){return(this.currentPage-1)*this.pageSize+e},toggleEditMessage(e){if(this.editingMessageIndex===e)this.cancelEditMessage();else{const t=this.messages[e];this.editingContent=this.getMessageContent(t),this.editingMessageIndex=e}},cancelEditMessage(){this.editingMessageIndex=null,this.editingContent=""},saveEditMessage(){if(null===this.editingMessageIndex)return;const e=this.messages[this.editingMessageIndex];e.swipes&&e.swipes.length>0?e.swipes[e.currentSwipeIndex]=this.editingContent:e.mes=this.editingContent,this.cancelEditMessage()},renderContent(e,t){if(!e)return"";let a=this.applyTagFilters(e);a=this.applyRegexScripts(a);const s=[];let i=a;const o=e=>`{ST_READER_HTML_BLOCK_${e}}`,n=i.indexOf("<style");if(-1!==n){let e=i.length;const t=i.substring(n);let a=-1,r=t.indexOf("</div>",0);while(-1!==r)a=r+6,r=t.indexOf("</div>",r+1);if(-1!==a){const s=t.substring(a).trim();s.startsWith("<")&&!s.startsWith("</")||(e=n+a)}const l=i.substring(n,e);s.push(l),i=i.substring(0,n)+o(0)+i.substring(e)}i=i.replace(/<details[\s\S]*?<\/details>/gi,e=>(s.push(e),o(s.length-1))),Fi.xI.setOptions({breaks:!0,gfm:!0,sanitize:!1,mangle:!1,headerIds:!1});let r=Fi.xI.parse(i);return s.forEach((e,t)=>{const a=o(t);r=r.includes(`<p>${a}</p>`)?r.replace(`<p>${a}</p>`,e):r.replace(a,e)}),r=wi.A.sanitize(r,this.getDOMPurifyConfig()),void 0!==t&&(r=this.applyHighlights(r,t)),r},applyHighlights(e,t){if(!this.highlights||0===this.highlights.length)return e;let a=e;for(const i of this.highlights)if(i.text&&i.messageIndex===t){const e=i.text.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");try{const t=new RegExp(`(${e})`);a=a.replace(t,`<span class="user-highlight" data-highlight-id="${i.id}">$1</span>`)}catch(s){}}return a},formatDate(e){if(!e)return"";let t;if("number"===typeof e)t=new Date(e);else{if("string"!==typeof e)return"";t=new Date(e),isNaN(t.getTime())&&(t=new Date(parseInt(e)))}if(isNaN(t.getTime()))return"";const a=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),o=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0");return`${a}-${s}-${i} ${o}:${n}`},async resetReader(){const e="⚠️【警告】即将关闭阅读器\n\n此操作将清空当前的会话缓存。\n如果您有未导出的收藏夹数据，可能会因此丢失。\n\n请确认：您是否已经备份了重要数据？";confirm(e)&&(this.viewMode="home",this.resetReaderStateOnly(),this.zipFileCache=null,this.dashboardData={totalFiles:0,groups:{}},this.currentFileName="",this.favorites=[],await this.clearDB())},prevPage(){this.currentPage>1&&(this.currentPage--,this.scrollToTop())},nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.scrollToTop())},goToPage(e){e>=1&&e<=this.totalPages&&(this.currentPage=e,this.scrollToTop())},onPageSizeChange(){this.currentPage>this.totalPages&&(this.currentPage=this.totalPages||1),this.scrollToTop()},scrollToTop(){this.$nextTick(()=>{const e=document.querySelector(".messages-wrapper");e&&e.scrollIntoView({behavior:"smooth",block:"start"})})},toggleSearchBar(){this.showSearchBar=!this.showSearchBar,this.showSearchBar?this.$nextTick(()=>{const e=document.querySelector(".search-input");e&&e.focus()}):this.clearSearch()},onSearchInput(){this.currentPage=1},clearSearch(){this.searchQuery="",this.currentPage=1},async loadFavoritesFromStorage(){if(this.currentFileName)try{const e=await this.initDB(),t=e.transaction(["fileFavorites"],"readonly"),a=t.objectStore("fileFavorites"),s=a.get(this.currentFileName);s.onsuccess=e=>{this.favorites=e.target.result||[],console.log(`已加载 ${this.currentFileName} 的收藏夹，共 ${this.favorites.length} 条`)}}catch(e){console.error("加载收藏失败:",e),this.favorites=[]}else this.favorites=[]},async saveFavoritesToStorage(){if(this.currentFileName)try{const e=await this.initDB(),t=e.transaction(["fileFavorites"],"readwrite"),a=t.objectStore("fileFavorites"),s=JSON.parse(JSON.stringify(this.favorites));a.put(s,this.currentFileName)}catch(e){console.error("保存收藏失败:",e)}},loadHighlightsFromStorage(){try{const e=localStorage.getItem("st_reader_highlights");e&&(this.highlights=JSON.parse(e))}catch(e){console.error("加载高亮失败:",e)}},saveHighlightsToStorage(){try{localStorage.setItem("st_reader_highlights",JSON.stringify(this.highlights))}catch(e){console.error("保存高亮失败:",e)}},toggleFavoritesPanel(){this.showFavoritesPanel=!this.showFavoritesPanel},toggleFavoriteMessage(e,t){const a=this.favorites.findIndex(t=>"message"===t.type&&t.messageIndex===e);-1!==a?this.favorites.splice(a,1):this.favorites.unshift({id:this.generateUUID(),type:"message",messageIndex:e,text:this.getMessageContent(t),speaker:t.name,createdAt:Date.now()}),this.saveFavoritesToStorage()},isMessageFavorited(e){return this.favorites.some(t=>"message"===t.type&&t.messageIndex===e)},handleTextSelection(e,t,a){const s=window.getSelection(),i=s.toString().trim();i.length>0&&(this.selectionMenu={show:!0,x:e.clientX,y:e.clientY-40,text:i,messageIndex:t,speaker:a.name})},hideSelectionMenu(e){e.target.closest(".selection-menu")||(this.selectionMenu.show=!1)},favoriteSelectedText(){this.selectionMenu.text&&(this.favorites.unshift({id:this.generateUUID(),type:"text",messageIndex:this.selectionMenu.messageIndex,text:this.selectionMenu.text,speaker:this.selectionMenu.speaker,createdAt:Date.now()}),this.saveFavoritesToStorage(),this.selectionMenu.show=!1,window.getSelection().removeAllRanges())},highlightSelectedText(){this.selectionMenu.text&&(this.highlights.push({id:this.generateUUID(),messageIndex:this.selectionMenu.messageIndex,text:this.selectionMenu.text,createdAt:Date.now()}),this.saveHighlightsToStorage(),this.selectionMenu.show=!1,window.getSelection().removeAllRanges(),this.readingMode&&this.generateReadingContent())},deleteHighlight(e){const t=this.highlights.findIndex(t=>t.id===e);-1!==t&&(this.highlights.splice(t,1),this.saveHighlightsToStorage(),this.readingMode&&this.generateReadingContent())},onHighlightClick(e){const t=e.target.closest(".user-highlight");t&&t.dataset.highlightId&&(e.preventDefault(),e.stopPropagation(),this.highlightMenu={show:!0,x:e.clientX,y:e.clientY,highlightId:t.dataset.highlightId})},removeHighlightFromMenu(){this.highlightMenu.highlightId&&this.deleteHighlight(this.highlightMenu.highlightId),this.highlightMenu.show=!1},hideHighlightMenu(e){e&&e.target.closest(".highlight-menu")||(this.highlightMenu.show=!1)},navigateToFavorite(e){if(void 0===e.messageIndex||null===e.messageIndex)return;const t=e.messageIndex,a=Math.floor(t/this.pageSize)+1;a!==this.currentPage&&(this.currentPage=a),this.showFavoritesPanel=!1,this.$nextTick(()=>{const e=t%this.pageSize,a=document.querySelectorAll(".message-block");a[e]&&(a[e].scrollIntoView({behavior:"smooth",block:"center"}),a[e].classList.add("highlight-flash"),setTimeout(()=>{a[e].classList.remove("highlight-flash")},2e3))})},copySelectedText(){this.selectionMenu.text&&navigator.clipboard.writeText(this.selectionMenu.text).then(()=>{this.selectionMenu.show=!1})},copyFavorite(e){navigator.clipboard.writeText(e.text)},deleteFavorite(e){this.favorites=this.favorites.filter(t=>t.id!==e),this.saveFavoritesToStorage()},clearAllFavorites(){confirm("确定要清空所有收藏吗？")&&(this.favorites=[],this.saveFavoritesToStorage())},exportFavorites(){const e=JSON.stringify(this.favorites,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download="favorites.json",s.click(),URL.revokeObjectURL(a)},formatFavoriteTime(e){const t=new Date(e);return`${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2,"0")}`},loadTagFiltersFromStorage(){try{const e=localStorage.getItem("st_reader_tag_filters");e&&(this.tagFilters=JSON.parse(e))}catch(e){console.error("加载标签过滤器失败:",e)}},saveTagFiltersToStorage(){try{localStorage.setItem("st_reader_tag_filters",JSON.stringify(this.tagFilters))}catch(e){console.error("保存标签过滤器失败:",e)}},toggleTagFilterManager(){this.showTagFilterManager=!this.showTagFilterManager,this.showTagFilterManager||this.resetTagFilterForm()},resetTagFilterForm(){this.editingTagFilter=null,this.tagFilterForm={id:"",name:"",tagName:"",mode:"remove",disabled:!1}},addNewTagFilter(){this.resetTagFilterForm(),this.tagFilterForm.id=this.generateUUID()},editTagFilter(e){this.editingTagFilter=e.id,this.tagFilterForm={...e}},saveTagFilter(){if(this.tagFilterForm.name&&this.tagFilterForm.tagName){if(this.editingTagFilter){const e=this.tagFilters.findIndex(e=>e.id===this.editingTagFilter);-1!==e&&this.tagFilters.splice(e,1,{...this.tagFilterForm})}else this.tagFilters.push({...this.tagFilterForm});this.saveTagFiltersToStorage(),this.resetTagFilterForm()}else alert("请填写过滤器名称和标签名")},cancelEditTagFilter(){this.resetTagFilterForm()},deleteTagFilter(e){confirm("确定要删除这个过滤器吗？")&&(this.tagFilters=this.tagFilters.filter(t=>t.id!==e),this.saveTagFiltersToStorage())},toggleTagFilter(e){e.disabled=!e.disabled,this.saveTagFiltersToStorage()},moveTagFilterUp(e){if(e>0){const t=this.tagFilters[e];this.tagFilters.splice(e,1),this.tagFilters.splice(e-1,0,t),this.saveTagFiltersToStorage()}},moveTagFilterDown(e){if(e<this.tagFilters.length-1){const t=this.tagFilters[e];this.tagFilters.splice(e,1),this.tagFilters.splice(e+1,0,t),this.saveTagFiltersToStorage()}},applyTagFilters(e){if(!e)return e;let t=e;for(const s of this.tagFilters)if(!s.disabled)try{const a=s.tagName.split(",").map(e=>e.trim()).filter(e=>e);for(const i of a){const a=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if("remove"===s.mode){const e=new RegExp(`<${a}[^>]*>[\\s\\S]*?<\\/${a}>`,"gi");t=t.replace(e,"");const s=new RegExp(`<${a}[^>]*/?>`,"gi");t=t.replace(s,"")}else if("keep"===s.mode){const s=new RegExp(`<${a}[^>]*>([\\s\\S]*?)<\\/${a}>`,"gi"),i=[];let o;while(null!==(o=s.exec(e)))i.push(o[1]);i.length>0&&(t=i.join("\n\n"))}else if("unwrap"===s.mode){const e=new RegExp(`<${a}[^>]*>([\\s\\S]*?)<\\/${a}>`,"gi");t=t.replace(e,"$1");const s=new RegExp(`<${a}[^>]*/?>`,"gi");t=t.replace(s,"")}}}catch(a){console.error(`标签过滤器 "${s.name}" 执行失败:`,a)}return t},loadScriptsFromStorage(){try{const e=localStorage.getItem("st_reader_regex_scripts");e&&(this.regexScripts=JSON.parse(e))}catch(e){console.error("加载正则脚本失败:",e)}},saveScriptsToStorage(){try{localStorage.setItem("st_reader_regex_scripts",JSON.stringify(this.regexScripts))}catch(e){console.error("保存正则脚本失败:",e)}},toggleRegexManager(){this.showRegexManager=!this.showRegexManager,this.showRegexManager||this.resetScriptForm()},resetScriptForm(){this.editingScript=null,this.scriptForm={id:"",scriptName:"",findRegex:"",replaceString:"",disabled:!1}},addNewScript(){this.resetScriptForm(),this.scriptForm.id=this.generateUUID()},editScript(e){this.editingScript=e.id,this.scriptForm={...e}},saveScript(){if(this.scriptForm.scriptName&&this.scriptForm.findRegex){if(this.editingScript){const e=this.regexScripts.findIndex(e=>e.id===this.editingScript);-1!==e&&this.regexScripts.splice(e,1,{...this.scriptForm})}else this.regexScripts.push({...this.scriptForm});this.saveScriptsToStorage(),this.resetScriptForm()}else alert("请填写脚本名称和正则表达式")},cancelEdit(){this.resetScriptForm()},deleteScript(e){confirm("确定要删除这个正则脚本吗？")&&(this.regexScripts=this.regexScripts.filter(t=>t.id!==e),this.saveScriptsToStorage())},toggleScript(e){e.disabled=!e.disabled,this.saveScriptsToStorage()},moveScriptUp(e){if(e>0){const t=this.regexScripts[e];this.regexScripts.splice(e,1),this.regexScripts.splice(e-1,0,t),this.saveScriptsToStorage()}},moveScriptDown(e){if(e<this.regexScripts.length-1){const t=this.regexScripts[e];this.regexScripts.splice(e,1),this.regexScripts.splice(e+1,0,t),this.saveScriptsToStorage()}},handleDragStart(e){this.dragIndex=e},handleDragOver(e){e.preventDefault()},handleDrop(e,t){if(e.preventDefault(),null!==this.dragIndex&&this.dragIndex!==t){const e=this.regexScripts[this.dragIndex];this.regexScripts.splice(this.dragIndex,1),this.regexScripts.splice(t,0,e),this.saveScriptsToStorage()}this.dragIndex=null},handleDragEnd(){this.dragIndex=null},generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0,a="x"===e?t:3&t|8;return a.toString(16)})},importScripts(){const e=document.createElement("input");e.type="file",e.accept=".json",e.multiple=!0,e.onchange=async e=>{const t=Array.from(e.target.files);if(!t.length)return;let a=0,s=0;const i=e=>new Promise(t=>{const a=new FileReader;a.onload=a=>{try{const e=JSON.parse(a.target.result);t(e)}catch(s){console.error(`解析文件 ${e.name} 失败:`,s),t(null)}},a.readAsText(e)}),o=await Promise.all(t.map(e=>i(e)));o.forEach(e=>{if(!e)return;a++;const t=Array.isArray(e)?e:[e];t.forEach(e=>{if(e.findRegex){const t={id:e.id||this.generateUUID(),scriptName:e.scriptName||"未命名脚本",findRegex:e.findRegex,replaceString:e.replaceString||"",disabled:e.disabled||!1},a=this.regexScripts.findIndex(e=>e.id===t.id);-1!==a?this.regexScripts.splice(a,1,t):this.regexScripts.push(t),s++}})}),s>0?(this.saveScriptsToStorage(),alert(`成功从 ${a} 个文件中导入了 ${s} 个脚本`)):alert("未找到有效的正则脚本数据")},e.click()},exportScripts(){const e=JSON.stringify(this.regexScripts,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download="regex_scripts.json",s.click(),URL.revokeObjectURL(a)},importFromCardOrPreset(){const e=document.createElement("input");e.type="file",e.accept=".png,.json",e.onchange=async e=>{const t=e.target.files[0];if(t)try{let e=null;if(t.name.toLowerCase().endsWith(".png")){const a=await t.arrayBuffer(),s=this.extractPNGChara(a);if(!s)return void alert("未能从 PNG 中读取数据，请确保这是一个有效的角色卡文件。");e=JSON.parse(s)}else if(t.name.toLowerCase().endsWith(".json")){const a=await t.text();e=JSON.parse(a)}if(!e)return void alert("无法解析文件数据。");const a=this.findRegexScriptsInObject(e);if(!a||0===a.length)return void(e.prompts?alert('该 JSON 文件包含 Prompt 预设，但未发现 "regex_scripts" (正则脚本) 字段。'):alert("在该文件中未找到正则脚本数据。"));this.batchImportScripts(a)}catch(a){console.error("导入失败:",a),alert("导入失败: "+a.message)}},e.click()},findRegexScriptsInObject(e){if(!e)return[];if(Array.isArray(e))return e.length>0&&(e[0].scriptName||e[0].regex||e[0].findRegex)?e:[];if(e.data?.extensions?.regex_scripts)return e.data.extensions.regex_scripts;if(e.extensions?.regex_scripts)return e.extensions.regex_scripts;if(e.regex_scripts)return e.regex_scripts;if(e.presets&&e.presets.regex_scripts)return e.presets.regex_scripts;for(const t in e)if("regex_scripts"===t&&Array.isArray(e[t]))return e[t];return[]},batchImportScripts(e){if(!Array.isArray(e))return;let t=0;e.forEach(e=>{const a=e.findRegex||e.regex,s=e.replaceString||e.replacement||"";if(a){const i={id:e.id||this.generateUUID(),scriptName:e.scriptName||"未命名脚本",findRegex:a,replaceString:s,disabled:e.disabled||!1},o=this.regexScripts.findIndex(e=>e.id===i.id||e.scriptName===i.scriptName);if(-1!==o){const e=this.regexScripts[o];e.findRegex===i.findRegex&&e.replaceString===i.replaceString||(i.id=this.generateUUID(),i.scriptName=i.scriptName+" (导入副本)",this.regexScripts.push(i),t++)}else this.regexScripts.push(i),t++}}),t>0?(this.saveScriptsToStorage(),alert(`成功导入 ${t} 个正则脚本！`)):alert("未导入任何新脚本（可能是重复或格式无效）。")},extractPNGChara(e){const t=new Uint8Array(e),a=[137,80,78,71,13,10,26,10];for(let o=0;o<8;o++)if(t[o]!==a[o])throw new Error("不是有效的 PNG 文件");let s=8;while(s<t.length){const e=t[s]<<24|t[s+1]<<16|t[s+2]<<8|t[s+3];s+=4;const a=String.fromCharCode(t[s],t[s+1],t[s+2],t[s+3]);if(s+=4,"tEXt"===a){const a=t.slice(s,s+e);let o=-1;for(let e=0;e<a.length;e++)if(0===a[e]){o=e;break}if(-1!==o){const e=(new TextDecoder).decode(a.slice(0,o));if("chara"===e){const e=(new TextDecoder).decode(a.slice(o+1));try{return this.decodeBase64UTF8(e)}catch(i){console.error("Base64 解码失败:",i)}}}}if(s+=e+4,"IEND"===a)break}return null},decodeBase64UTF8(e){const t=atob(e),a=new Uint8Array(t.length);for(let s=0;s<t.length;s++)a[s]=t.charCodeAt(s);return new TextDecoder("utf-8").decode(a)},applyRegexScripts(e){if(!e)return e;let t=e;for(const s of this.regexScripts)if(!s.disabled)try{const e=s.findRegex.match(/^\/(.*)\/([gimsuy]*)$/);let a;a=e?new RegExp(e[1],e[2]):new RegExp(s.findRegex,"g"),t=t.replace(a,s.replaceString)}catch(a){console.error(`正则脚本 "${s.scriptName}" 执行失败:`,a)}return t},openExportRangeDialog(){this.exportDialog={show:!0,startFloor:1,endFloor:this.filteredMessages.length,includeName:!0,includeTime:!0}},closeExportDialog(){this.exportDialog.show=!1},getExportCount(){const e=Math.max(1,Math.min(this.exportDialog.startFloor,this.filteredMessages.length)),t=Math.max(1,Math.min(this.exportDialog.endFloor,this.filteredMessages.length));return Math.max(0,t-e+1)},formatMessageForExport(e,t){let a=this.getMessageContent(e);a=this.applyTagFilters(a),a=this.applyRegexScripts(a),a=this.stripHtmlTags(a);let s="";return s+=`========== 第 ${t} 楼 ==========\n`,this.exportDialog.includeName&&(s+=`【${e.name}】`),this.exportDialog.includeTime&&e.send_date&&(this.exportDialog.includeName&&(s+=" "),s+=`[${e.send_date}]`),(this.exportDialog.includeName||this.exportDialog.includeTime)&&(s+="\n\n"),s+=a,s},getExportPreview(){const e=Math.max(1,Math.min(this.exportDialog.startFloor,this.filteredMessages.length)),t=Math.max(1,Math.min(this.exportDialog.endFloor,this.filteredMessages.length));if(e>t||e<1)return"无效的楼层范围";const a=Math.min(3,t-e+1);let s="";for(let i=0;i<a;i++){const t=e+i,a=this.filteredMessages[t-1];a&&(i>0&&(s+="\n\n"),s+=this.formatMessageForExport(a,t))}return t-e+1>3&&(s+="\n\n...(还有 "+(t-e+1-3)+" 条消息)"),s.length>800&&(s=s.substring(0,800)+"\n...(预览已截断)"),s},stripHtmlTags(e){if(!e)return"";const t=document.createElement("div");t.innerHTML=e;let a=t.textContent||t.innerText||"";return a=a.replace(/\n{3,}/g,"\n\n"),a.trim()},doExportRange(){const e=Math.max(1,Math.min(this.exportDialog.startFloor,this.filteredMessages.length)),t=Math.max(1,Math.min(this.exportDialog.endFloor,this.filteredMessages.length));if(e>t||e<1)return void alert("请输入有效的楼层范围");let a="";for(let l=e;l<=t;l++){const t=this.filteredMessages[l-1];t&&(l>e&&(a+="\n\n\n"),a+=this.formatMessageForExport(t,l))}const s=new Blob([a],{type:"text/plain;charset=utf-8"}),i=URL.createObjectURL(s),o=document.createElement("a");o.href=i;const n=(new Date).toISOString().slice(0,10),r=this.metadata.character_name||"聊天记录";o.download=`${r}_楼层${e}-${t}_${n}.txt`,o.click(),URL.revokeObjectURL(i),this.closeExportDialog()},toggleStylePanel(){this.showStylePanel=!this.showStylePanel},loadStylesFromStorage(){try{const e=localStorage.getItem("st_reader_text_styles");if(e){const t=JSON.parse(e);this.textStyles={...this.textStyles,...t}}}catch(e){console.error("加载样式设置失败:",e)}},saveStylesToStorage(){try{localStorage.setItem("st_reader_text_styles",JSON.stringify(this.textStyles))}catch(e){console.error("保存样式设置失败:",e)}},handleStyleChange(){this.saveStylesToStorage(),this.readingMode&&this.handleResize()},resetStyles(){const e=this.isDarkMode?"#e0e0e0":"#1a1a1a";this.textStyles={fontFamily:"system",fontSize:16,lineHeight:1.8,paragraphSpacing:1,letterSpacing:0,textColor:e,italicColor:e,underlineColor:e,quoteColor:e,textAlign:"justify"},this.saveStylesToStorage()},setTextColor(e){this.textStyles.textColor=e,this.saveStylesToStorage()},setTextAlign(e){this.textStyles.textAlign=e,this.saveStylesToStorage()},loadCustomFonts(){try{const e=localStorage.getItem("st_reader_custom_fonts");e&&(this.customFonts=JSON.parse(e),this.customFonts.forEach(e=>{this.registerFontFace(e)}))}catch(e){console.error("加载自定义字体失败:",e)}},saveCustomFonts(){try{localStorage.setItem("st_reader_custom_fonts",JSON.stringify(this.customFonts))}catch(e){console.error("保存自定义字体失败:",e)}},registerFontFace(e){const t=document.createElement("style");t.id=`custom-font-${e.id}`,t.textContent=`\n        @font-face {\n          font-family: "${e.name}";\n          src: url("${e.url}") format("${e.format}");\n          font-weight: normal;\n          font-style: normal;\n          font-display: swap;\n        }\n      `,document.head.appendChild(t)},unregisterFontFace(e){const t=document.getElementById(`custom-font-${e}`);t&&t.remove()},async addCustomFont(){if(!this.customFontForm.name)return void alert("请输入字体名称");let e="",t="truetype";if(this.customFontForm.file)try{e=await this.fileToDataUrl(this.customFontForm.file),t=this.getFontFormat(this.customFontForm.file.name)}catch(i){return void alert("读取字体文件失败: "+i.message)}else{if(!this.customFontForm.url)return void alert("请选择字体文件或输入字体URL");e=this.customFontForm.url,t=this.getFontFormat(this.customFontForm.url)}const a=Date.now().toString(),s={id:a,name:this.customFontForm.name,url:e,format:t};this.registerFontFace(s),this.customFonts.push(s),this.saveCustomFonts(),this.resetCustomFontForm(),this.showCustomFontDialog=!1,this.textStyles.fontFamily="custom-"+a,this.saveStylesToStorage()},deleteCustomFont(e){confirm("确定要删除这个自定义字体吗？")&&(this.textStyles.fontFamily==="custom-"+e&&(this.textStyles.fontFamily="system",this.saveStylesToStorage()),this.unregisterFontFace(e),this.customFonts=this.customFonts.filter(t=>t.id!==e),this.saveCustomFonts())},fileToDataUrl(e){return new Promise((t,a)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=a,s.readAsDataURL(e)})},getFontFormat(e){const t=e.split(".").pop().toLowerCase(),a={ttf:"truetype",otf:"opentype",woff:"woff",woff2:"woff2"};return a[t]||"truetype"},handleFontFileSelect(e){const t=e.target.files[0];t&&(this.customFontForm.file=t,this.customFontForm.name||(this.customFontForm.name=t.name.replace(/\.(ttf|otf|woff2?|TTF|OTF|WOFF2?)$/,"")))},resetCustomFontForm(){this.customFontForm={name:"",url:"",file:null};const e=this.$refs.fontFileInput;e&&(e.value="")},getPreviewStyles(){return{...this.getContentStyles(),color:"var(--main-color)"}},getContentStyles(){return{fontFamily:this.getFontFamily(),fontSize:this.textStyles.fontSize+"px",lineHeight:this.textStyles.lineHeight,textAlign:this.textStyles.textAlign,letterSpacing:this.textStyles.letterSpacing+"px","--main-color":this.textStyles.textColor,"--italic-color":this.textStyles.italicColor||this.textStyles.textColor,"--underline-color":this.textStyles.underlineColor||this.textStyles.textColor,"--quote-color":this.textStyles.quoteColor||"#666666","--paragraph-spacing":this.textStyles.paragraphSpacing+"em","--content-font":this.getFontFamily()}},getFontFamily(){const e={system:'-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif',serif:'"Noto Serif SC", "Source Han Serif SC", "SimSun", "宋体", serif',"sans-serif":'"Noto Sans SC", "Source Han Sans SC", "Microsoft YaHei", "微软雅黑", sans-serif',kaiti:'"KaiTi", "楷体", "STKaiti", "华文楷体", serif',fangsong:'"FangSong", "仿宋", "STFangsong", "华文仿宋", serif',monospace:'"Consolas", "Monaco", "Source Code Pro", monospace',alegreya:'"Alegreya", serif',cangeryunhei:'"仓耳云黑", sans-serif',huiwenmingchao:'"汇文明朝", serif',kongmingchao:'"空明朝", serif',pingxianzhensong:'"屏显臻宋", serif',wenyueminguofangsong:'"文悦民国仿宋", serif'};if(this.textStyles.fontFamily.startsWith("custom-")){const e=this.textStyles.fontFamily.replace("custom-",""),t=this.customFonts.find(t=>t.id===e);if(t)return`"${t.name}", sans-serif`}return e[this.textStyles.fontFamily]||e["system"]},toggleReadingMode(){this.readingMode=!this.readingMode,this.readingMode?(this.toolbarVisible=!1,this.showSearchBar=!1,this.showRegexManager=!1,this.showTagFilterManager=!1,this.showFavoritesPanel=!1,this.showStylePanel=!1,this.selectionMenu.show=!1,this.readingCurrentPage=1,document.body.style.overflow="hidden",this.generateReadingContent(),window.addEventListener("resize",this.handleResize),this.$nextTick(()=>{this.$refs.readingContentEl&&(this.resizeObserver=new ResizeObserver(()=>{window.requestAnimationFrame(()=>{this.calculateTotalPages()})}),this.resizeObserver.observe(this.$refs.readingContentEl))})):(document.body.style.overflow="",this.toolbarVisible=!1,window.removeEventListener("resize",this.handleResize),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null))},generateReadingContent(){let e="";const t=this.paginatedMessages,a=(this.currentPage-1)*this.pageSize;for(let s=0;s<t.length;s++){const i=t[s],o=a+s;let n=this.getMessageContent(i);n=this.renderContent(n,o),s>0&&(e+='<div class="reading-separator"></div>'),e+=`<div class="reading-message" data-floor="${o}">`,i.name&&(e+=`<p class="reading-speaker-name">【${i.name}】</p>`),e+=n,e+="</div>"}this.keepReadingPagePosition||(this.readingCurrentPage=1),this.keepReadingPagePosition=!1,this.readingFullHtml=e,this.$nextTick(()=>{const e=this.$refs.readingContentEl;e&&(e.style.width=""),this.updateColumnWidth(),this.$nextTick(()=>{setTimeout(()=>{this.calculateTotalPages()},50)})})},updateColumnWidth(){const e=this.$refs.readingContentEl;e&&(e.style.columnWidth=`${window.innerWidth}px`)},parseSTDate(e){if(!e)return null;if("number"===typeof e)return new Date(e);let t=String(e).trim();if(t.includes("@"))try{const e=t.replace("@","T").replace("h",":").replace("m",":").replace("s",""),a=new Date(e);if(!isNaN(a.getTime()))return a}catch(s){console.warn("解析 @ 格式日期失败:",t)}let a=new Date(t);if(!isNaN(a.getTime()))return a;if(/am|pm/i.test(t)&&!/\s(am|pm)/i.test(t)){const e=t.replace(/(\d)(am|pm)/i,"$1 $2");if(a=new Date(e),!isNaN(a.getTime()))return a}return null},calculateTotalPages(){const e=this.$refs.readingContentEl;if(!e)return;const t=window.innerWidth,a=e.scrollWidth,s=e.offsetWidth;a>s&&(e.style.width=`${a}px`),this.windowWidth=t;const i=Math.max(1,Math.ceil((a-20)/t)),o=i*t;e.style.width=`${o}px`,this.readingTotalPages=i,this.readingCurrentPage>this.readingTotalPages&&(this.readingCurrentPage=this.readingTotalPages),console.groupEnd()},handleResize(){this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(()=>{const e=this.$refs.readingContentEl;e&&(e.style.width=""),this.updateColumnWidth(),this.$nextTick(()=>{setTimeout(()=>{this.calculateTotalPages()},50)})},100)},getReadingTransform(){const e=(this.readingCurrentPage-1)*this.windowWidth;return{transform:`translateX(-${e}px)`,...this.getContentStyles()}},getReadingFloorRange(){const e=(this.currentPage-1)*this.pageSize+1,t=Math.min(this.currentPage*this.pageSize,this.filteredMessages.length);return`${e}-${t} 楼`},readingPrevPage(){this.readingCurrentPage>1?this.readingCurrentPage--:this.currentPage>1&&(this.currentPage--,this.keepReadingPagePosition=!0,this.generateReadingContent(),this.$nextTick(()=>{setTimeout(()=>{this.readingCurrentPage=this.readingTotalPages},100)}))},readingNextPage(){this.readingCurrentPage<this.readingTotalPages?this.readingCurrentPage++:this.currentPage<this.totalPages&&(this.currentPage++,this.generateReadingContent())},handleReadingClick(e){const t=window.getSelection();if(t.toString().length>0)return;const{clientX:a}=e,{innerWidth:s}=window,i=.25*s,o=.75*s;a<i?this.readingPrevPage():a>o?this.readingNextPage():this.showReadingMenu=!this.showReadingMenu},onReadingTouchStart(e){this.readingTouchStartX=e.touches[0].clientX,this.readingTouchStartY=e.touches[0].clientY},onReadingTouchEnd(e){const t=e.changedTouches[0].clientX,a=e.changedTouches[0].clientY,s=t-this.readingTouchStartX,i=a-this.readingTouchStartY;Math.abs(s)>Math.abs(i)&&Math.abs(s)>50&&(s>0?this.readingPrevPage():this.readingNextPage())},onReadingMouseUp(e){const t=window.getSelection(),a=t.toString().trim();if(a.length>0){let s=null;const i=t.getRangeAt(0),o=i.commonAncestorContainer;let n=3===o.nodeType?o.parentElement:o;while(n&&n!==document.body){if(n.classList&&n.classList.contains("reading-message")&&n.hasAttribute("data-floor")){s=parseInt(n.getAttribute("data-floor"));break}n=n.parentElement}this.selectionMenu={show:!0,x:e.clientX,y:e.clientY-40,text:a,messageIndex:s,speaker:null!==s&&this.filteredMessages[s]?this.filteredMessages[s].name:""}}},toggleToolbar(){this.toolbarVisible=!this.toolbarVisible,this.toolbarVisible&&(this.toolbarTimeout&&clearTimeout(this.toolbarTimeout),this.toolbarTimeout=setTimeout(()=>{this.toolbarVisible=!1},3e3))},handleKeydown(e){this.readingMode&&"Escape"===e.key&&this.toggleReadingMode(),this.readingMode&&("ArrowLeft"===e.key?this.readingPrevPage():"ArrowRight"===e.key&&this.readingNextPage())},openIntimacyModal(){this.calculateIntimacyStats(),this.showIntimacyModal=!0},calculateIntimacyStats(){if(!this.messages.length)return;const e=this.messages.filter(e=>e.send_date);if(!e.length)return;const t=[...e].sort((e,t)=>{const a=this.parseSTDate(e.send_date)?.getTime()||0,s=this.parseSTDate(t.send_date)?.getTime()||0;return a-s});let a=0,s=0;const i=new Map;t.forEach((e,t)=>{const o=this.getMessageContent(e),n=o?o.length:0;o&&(a+=n),t>0&&e.swipes&&e.swipes.length>1&&(s+=e.swipes.length-1);const r=this.parseSTDate(e.send_date);if(r){const e=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0"),a=String(r.getDate()).padStart(2,"0"),s=`${e}-${t}-${a}`;i.has(s)||i.set(s,{count:0,chars:0});const o=i.get(s);o.count+=1,o.chars+=n}});let o=0;for(const d of i.values())d.count>o&&(o=d.count);const n=[248,187,208],r=[233,30,99],l=this.parseSTDate(t[0].send_date),c=this.parseSTDate(t[t.length-1].send_date)||new Date;if(l){this.intimacyData.firstDate=l.toLocaleDateString();const e=new Date;this.intimacyData.daysSince=Math.floor((e-l)/864e5);const t=[];let a=l.getFullYear(),s=l.getMonth();const d=c.getFullYear(),h=c.getMonth();while(a<d||a===d&&s<=h){const e=new Date(a,s+1,0).getDate(),l=new Date(a,s,1),c=l.getDay(),d=[];let h=0,g=0;for(let t=1;t<=e;t++){const e=String(s+1).padStart(2,"0"),l=String(t).padStart(2,"0"),c=`${a}-${e}-${l}`,u=i.get(c)||{count:0,chars:0},p=u.count,m=u.chars;h+=p,g+=m;const v=this.getGradientColor(p,o,n,r);d.push({dayNum:t,dateStr:c,count:p,chars:m,bgStyle:v})}t.push({year:a,month:s+1,paddingStart:c,days:d,totalCount:h,totalChars:g}),s++,s>11&&(s=0,a++)}this.intimacyData.calendarMonths=t.reverse(),this.currentMonthIndex=0}else this.intimacyData.calendarMonths=[];this.intimacyData.activeDays=i.size,this.intimacyData.totalMessages=this.messages.length,this.intimacyData.totalChars=a,this.intimacyData.totalRerolls=s},showDayTooltip(e,t){0!==t.count&&(this.tooltip.show=!0,this.tooltip.dateStr=t.dateStr,this.tooltip.count=t.count,this.tooltip.chars=t.chars,this.updateTooltipPos(e))},moveDayTooltip(e){this.tooltip.show&&this.updateTooltipPos(e)},hideDayTooltip(){this.tooltip.show=!1},updateTooltipPos(e){const t=15;this.tooltip.x=e.clientX+t,this.tooltip.y=e.clientY+t},prevMonth(){this.currentMonthIndex<this.intimacyData.calendarMonths.length-1&&this.currentMonthIndex++},nextMonth(){this.currentMonthIndex>0&&this.currentMonthIndex--},openDashboardIntimacy(e,t){const a={};let s=0;t.forEach(e=>{s+=e.rerolls||e.totalRerolls||0,e.dateMap&&Object.entries(e.dateMap).forEach(([e,t])=>{a[e]||(a[e]={count:0,chars:0}),"number"===typeof t?a[e].count+=t:(a[e].count+=t.count,a[e].chars+=t.chars)})});let i=0,o=0,n=0;Object.values(a).forEach(e=>{e.count>i&&(i=e.count),o+=e.count,n+=e.chars});const r=Object.keys(a).sort();let l=0;if(r.length>0){const e=new Date(r[0]),t=new Date;l=Math.floor((t-e)/864e5),this.intimacyData.firstDate=`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()}`}else this.intimacyData.firstDate="未知";this.intimacyData.daysSince=l,this.intimacyData.activeDays=r.length,this.intimacyData.totalMessages=o,this.intimacyData.totalChars=n,this.intimacyData.totalRerolls=s;const c=[248,187,208],d=[194,24,91];if(r.length>0){const e=new Date(r[0]),t=new Date(r[r.length-1]),s=[];let o=e.getFullYear(),n=e.getMonth();const l=t.getFullYear(),h=t.getMonth();while(o<l||o===l&&n<=h){const e=new Date(o,n+1,0).getDate(),t=new Date(o,n,1),r=t.getDay(),l=[];let h=0,g=0;for(let s=1;s<=e;s++){const e=String(n+1).padStart(2,"0"),t=String(s).padStart(2,"0"),r=`${o}-${e}-${t}`,u=a[r]||{count:0,chars:0};h+=u.count,g+=u.chars;const p=this.getGradientColor(u.count,i,c,d);l.push({dayNum:s,dateStr:r,count:u.count,chars:u.chars,bgStyle:p})}s.push({year:o,month:n+1,paddingStart:r,days:l,totalCount:h,totalChars:g}),n++,n>11&&(n=0,o++)}this.intimacyData.calendarMonths=s.reverse(),this.currentMonthIndex=0}else this.intimacyData.calendarMonths=[];this.showIntimacyModal=!0},getGradientColor(e,t,a,s){if(0===e)return"";let i=e/t;i<.1&&(i=.1);const o=Math.round(a[0]+(s[0]-a[0])*i),n=Math.round(a[1]+(s[1]-a[1])*i),r=Math.round(a[2]+(s[2]-a[2])*i);return`rgb(${o}, ${n}, ${r})`},async initDB(){return new Promise((e,t)=>{const a=indexedDB.open("STReaderDB",1);a.onerror=()=>t("数据库打开失败"),a.onsuccess=t=>e(t.target.result),a.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("appState")||t.createObjectStore("appState"),t.objectStoreNames.contains("fileFavorites")||(t.createObjectStore("fileFavorites"),console.log("IndexedDB: fileFavorites store created"))}})},async saveToDB(e,t){const a=await this.initDB();return new Promise((s,i)=>{const o=a.transaction(["appState"],"readwrite"),n=o.objectStore("appState"),r=n.put(t,e);r.onsuccess=()=>s(),r.onerror=()=>i("保存失败")})},async getFromDB(e){const t=await this.initDB();return new Promise((a,s)=>{const i=t.transaction(["appState"],"readonly"),o=i.objectStore("appState"),n=o.get(e);n.onsuccess=e=>a(e.target.result),n.onerror=()=>s("读取失败")})},async clearDB(){const e=await this.initDB();return new Promise((t,a)=>{const s=e.transaction(["appState"],"readwrite"),i=s.objectStore("appState"),o=i.clear();o.onsuccess=()=>t(),o.onerror=()=>a()})},triggerImportFavorites(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=this.handleImportFavorites,e.click()},async handleImportFavorites(e){const t=e.target.files[0];if(t){try{const e=await t.text(),a=JSON.parse(e);if(!Array.isArray(a))return void alert("无效的收藏夹文件格式");let s=0,i=0;a.forEach(e=>{const t=this.favorites.some(t=>t.id===e.id),a=e.messageIndex<this.messages.length;!t&&a?(this.favorites.push(e),s++):i++}),s>0?(this.favorites.sort((e,t)=>e.messageIndex-t.messageIndex),await this.saveFavoritesToStorage(),alert(`成功导入 ${s} 条收藏${i>0?` (跳过 ${i} 条重复或无效项)`:""}`)):alert("没有导入任何新内容（可能是全部重复，或者楼层号超出了当前文件范围）")}catch(a){console.error(a),alert("导入失败：文件格式错误")}e.target.value=""}},async getAllFavoritesFromDB(){const e=await this.initDB();return new Promise((t,a)=>{const s=e.transaction(["fileFavorites"],"readonly"),i=s.objectStore("fileFavorites"),o=i.openCursor(),n=[];o.onsuccess=e=>{const a=e.target.result;a?(Array.isArray(a.value)&&a.value.length>0&&n.push({fileName:a.key,items:a.value}),a.continue()):t(n)},o.onerror=()=>a("读取全局收藏失败")})},async switchToGlobalFavorites(){this.viewingGlobalFavorites=!0,this.loadingStatus="正在加载所有收藏...";try{this.globalFavoritesList=await this.getAllFavoritesFromDB()}catch(e){console.error(e)}finally{this.loadingStatus=""}},switchToCurrentFavorites(){this.viewingGlobalFavorites=!1},async exportGlobalFavorites(){const e=await this.getAllFavoritesFromDB();if(0===e.length)return void alert("没有任何收藏数据");const t=JSON.stringify(e,null,2),a=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s;const o=(new Date).toISOString().slice(0,10);i.download=`ST_All_Favorites_Backup_${o}.json`,i.click(),URL.revokeObjectURL(s)},async deleteGlobalFavorite(e,t){if(confirm(`确定要从 "${e}" 的记录中删除这条收藏吗？`))try{const a=await this.initDB(),s=a.transaction(["fileFavorites"],"readwrite"),i=s.objectStore("fileFavorites"),o=i.get(e);o.onsuccess=a=>{const s=a.target.result||[],o=s.filter(e=>e.id!==t);i.put(o,e);const n=this.globalFavoritesList.find(t=>t.fileName===e);n&&(n.items=o,0===o.length&&(this.globalFavoritesList=this.globalFavoritesList.filter(t=>t.fileName!==e)))}}catch(a){console.error("删除失败",a)}}}},Ii=a(6262);const _i=(0,Ii.A)(Ei,[["render",Li],["__scopeId","data-v-75685e9c"]]);var Pi=_i;(0,s.Ef)(Pi).mount("#app")}},t={};function a(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s].call(o.exports,o,o.exports,a),o.exports}a.m=e,function(){var e=[];a.O=function(t,s,i,o){if(!s){var n=1/0;for(d=0;d<e.length;d++){s=e[d][0],i=e[d][1],o=e[d][2];for(var r=!0,l=0;l<s.length;l++)(!1&o||n>=o)&&Object.keys(a.O).every(function(e){return a.O[e](s[l])})?s.splice(l--,1):(r=!1,o<n&&(n=o));if(r){e.splice(d--,1);var c=i();void 0!==c&&(t=c)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[s,i,o]}}(),function(){a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,{a:t}),t}}(),function(){a.d=function(e,t){for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={524:0};a.O.j=function(t){return 0===e[t]};var t=function(t,s){var i,o,n=s[0],r=s[1],l=s[2],c=0;if(n.some(function(t){return 0!==e[t]})){for(i in r)a.o(r,i)&&(a.m[i]=r[i]);if(l)var d=l(a)}for(t&&t(s);c<n.length;c++)o=n[c],a.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return a.O(d)},s=self["webpackChunkst_reader"]=self["webpackChunkst_reader"]||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))}();var s=a.O(void 0,[504],function(){return a(2733)});s=a.O(s)})();
//# sourceMappingURL=app.9dd4c11d.js.map